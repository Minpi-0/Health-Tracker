<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>K-Glow Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com/"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        :root {
            --bg-color: #fbfbfe;
            --text-color: #040316; 
            --text-label: #4a5568; 
            --accent-color: #f9991a; 
            --primary-gray: #9caeba; 
            --soft-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.08);
            --glow-orange: 0 12px 25px -5px rgba(249, 153, 26, 0.4);
            --radius-standard: 16px; 
        }

        body {
            font-family: 'Inter', 'PingFang TC', 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5; 
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        #root {
            width: 100%;
            max-width: 430px; 
            height: 100vh;
            height: 100dvh; 
            background-color: var(--bg-color);
            position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* çµ±ä¸€æ¬„ä½èˆ‡è¦æ ¼ */
        input, select { 
            background-color: #f2f4f7 !important;
            border: none !important;
            border-radius: var(--radius-standard) !important; 
            height: 40px !important;
            padding: 0 12px !important; 
            font-size: 14px !important;
            outline: none !important;
            color: var(--text-color) !important;
            box-shadow: none !important;
        }

        textarea {
            background-color: #f2f4f7 !important;
            border: none !important;
            border-radius: var(--radius-standard) !important;
            padding: 12px 12px !important;
            font-size: 14px !important;
            color: var(--text-color) !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .premium-card {
            background: white;
            border-radius: var(--radius-standard);
            box-shadow: var(--soft-shadow);
            border: 1px solid rgba(156, 174, 186, 0.1);
        }

        .island-navbar {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            height: 72px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-standard);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 50;
        }

        .glow-action-btn {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #fbbf24, #f9991a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: var(--glow-orange);
            transform: translateY(-22px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 4px solid white;
            font-weight: 800;
        }
        .glow-action-btn:active {
            transform: translateY(-18px) scale(0.92);
        }

        .calendar-circle {
            width: 42px;
            height: 42px;
            border-radius: var(--radius-standard);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            transition: all 0.3s;
            position: relative;
            font-size: 13px;
        }
        
        .calendar-circle.fully-completed {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 4px 10px rgba(249, 153, 26, 0.3);
        }
        
        .calendar-circle.selected-border:not(.fully-completed) {
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            background-color: white;
        }

        .data-indicator-dot {
            width: 4px;
            height: 4px;
            background-color: var(--accent-color);
            border-radius: 50%;
            position: absolute;
            bottom: -8px;
        }

        .quick-period-btn {
            height: 40px;
            padding: 0 16px;
            background-color: white;
            border: 1px solid var(--primary-gray);
            border-radius: var(--radius-standard);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color);
            transition: all 0.2s;
        }

        /* ç¢ºèªç´€éŒ„ç‰¹æ•ˆå‹•ç•« */
        @keyframes success-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(15deg); }
            100% { transform: scale(1); }
        }
        .btn-success-anim {
            animation: success-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    </style>

    <script>
        window.tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#040316',
                        accent: '#f9991a',
                        muted: '#9caeba',
                        ice: '#f2f7ff',
                        label: '#4a5568'
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useMemo, useEffect, useRef } = React;

        // --- å…¨åŸŸçµ„ä»¶ï¼šIcon ---
        const Icon = ({ name, size = 24, className = "", fill = "none" }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (window.lucide && wrapperRef.current) {
                    wrapperRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({
                        root: wrapperRef.current,
                        attrs: { width: size, height: size, class: className, fill: fill }
                    });
                }
            }, [name, size, className, fill]);
            return <span ref={wrapperRef} className={`inline-flex items-center justify-center shrink-0 ${className}`} style={{ width: size, height: size }} />;
        };

        // --- å…¨åŸŸå¸¸æ•¸ ---
        const BODY_PARTS = ['æ ¸å¿ƒ', 'ä¸ŠåŠèº«', 'ä¸‹åŠèº«', 'å…¨èº«æµå‹•'];
        const DIET_TAGS = ['è›‹ç™½è³ªè¶³å¤ ', 'ä½é†£é£²é£Ÿ', 'è¼•é£Ÿç„¡è² æ“”', 'çå‹µé¤'];
        const MOOD_OPTIONS = [
            { icon: 'ğŸ”¥', label: 'æ¿€æ˜‚', value: 'excited' },
            { icon: 'ğŸ˜Š', label: 'èˆ’çˆ½', value: 'good' },
            { icon: 'ğŸ’¦', label: 'çˆ†æ±—', value: 'sweat' },
            { icon: 'ğŸ˜´', label: 'ç–²ç´¯', value: 'tired' }
        ];
        const DAILY_REINFORCEMENTS = [
          { name: 'æ­»èŸ²å¼ (Dead Bug)', desc: 'ç©©å®šæ·±å±¤æ ¸å¿ƒï¼Œæå‡è…°æ¤æ§åˆ¶åŠ›ã€‚' },
          { name: 'è²“ç‰›å¼ (Cat-Cow)', desc: 'å„ªåŒ–è„Šæ¤æ´»å‹•åº¦ï¼Œèˆ’ç·©èƒŒéƒ¨å£“åŠ›ã€‚' },
          { name: 'é³¥ç‹—å¼ (Bird-Dog)', desc: 'å¼·åŒ–å°å´ç©©å®šéˆï¼Œå»ºç«‹å¹³è¡¡åŠ›ã€‚' },
          { name: 'è‡€æ©‹ (Glute Bridge)', desc: 'å–šé†’è‡€éƒ¨è‚Œç¾¤ï¼Œåˆ†æ“”è…°éƒ¨å£“åŠ›ã€‚' },
          { name: 'å¤©éµå¼ (Swan)', desc: 'é–‹å±•èƒ¸è…”ç©ºé–“ï¼Œå¼·åŒ–ä¸ŠèƒŒè‚ŒåŠ›ã€‚' }
        ];
        const EXERCISE_LIBRARY = {
          'æ ¸å¿ƒåºŠ (Reformer)': [{ name: 'è¶³éƒ¨ç·´ç¿’', category: 'æ ¸å¿ƒåºŠ (Reformer)' }, { name: 'å¤§è±¡å¼', category: 'æ ¸å¿ƒåºŠ (Reformer)' }, { name: 'æ²è…¹', category: 'æ ¸å¿ƒåºŠ (Reformer)' }],
          'å¢Šä¸Š (Mat)': [{ name: 'ç™¾æ¬¡å‘¼å¸', category: 'å¢Šä¸Š (Mat)' }, { name: 'æ­»èŸ²å¼', category: 'å¢Šä¸Š (Mat)' }]
        };
        const DEFAULT_QUICK_FOODS = {
          breakfast: ["ç„¡ç³–è±†æ¼¿", "æ°´ç…®è›‹", "ç‡•éº¥ç‰‡"],
          lunch: ["èˆ’è‚¥é›èƒ¸", "å¥åº·é¤ç›’", "æ¸…è”¬æ²™æ‹‰"],
          dinner: ["æ¸…è’¸é­š", "å«©ç…è±†è…", "æ°´ç…®æ™‚è”¬"],
          snacks: ["ç¶œåˆå …æœ", "é«˜è›‹ç™½é£²", "ç„¡ç³–å„ªæ ¼"]
        };

        const App = () => {
            // --- 1. ç‹€æ…‹å®£å‘Š (useState) ---
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home'); 
            const [showEntryModal, setShowEntryModal] = useState(false);
            const [showPlanModal, setShowPlanModal] = useState(false);
            const [showGuideModal, setShowGuideModal] = useState(false);
            const [entryType, setEntryType] = useState('workout');
            const [editingId, setEditingId] = useState(null);
            const [confirmDelete, setConfirmDelete] = useState(null); 
            const [plans, setPlans] = useState([]);
            const [activePlanId, setActivePlanId] = useState(null);
            const [weekOffset, setWeekOffset] = useState(0);
            const [historyFilterDate, setHistoryFilterDate] = useState(new Date().toISOString().split('T')[0]);

            // è¡¨å–®è¼¸å…¥ç‹€æ…‹
            const [w_note, setWNote] = useState('');
            const [w_parts, setWParts] = useState([]);
            const [w_exercises, setWExercises] = useState([]);
            const [w_weight, setWWeight] = useState('');
            const [w_mood, setWMood] = useState('good');
            const [w_date, setWDate] = useState(new Date().toISOString().split('T')[0]);
            const [d_breakfast, setDBreakfast] = useState('');
            const [d_lunch, setDLunch] = useState('');
            const [d_dinner, setDDinner] = useState('');
            const [d_snacks, setDSnacks] = useState('');
            const [d_water, setDWater] = useState(2000);
            const [d_kcal, setDKcal] = useState(0); 
            const [d_p, setDP] = useState(0);
            const [d_c, setDC] = useState(0);
            const [d_f, setDF] = useState(0);
            const [d_tags, setDTags] = useState([]);
            const [d_date, setDDate] = useState(new Date().toISOString().split('T')[0]);

            // è¨ˆç•«è¼¸å…¥ç‹€æ…‹
            const [newPlanTitle, setNewPlanTitle] = useState('');
            const [newPlanDate, setNewPlanDate] = useState('');
            const [newPlanBaselineWeight, setNewPlanBaselineWeight] = useState('');
            const [newPlanTargetWeight, setNewPlanTargetWeight] = useState('');

            // ç‰¹æ•ˆç‹€æ…‹
            const [showCelebration, setShowCelebration] = useState(false);
            const [weightSavedEffect, setWeightSavedEffect] = useState(false);

            const touchStartX = useRef(null);
            const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : { apiKey: "" };
            const isConfigReady = firebaseConfig && firebaseConfig.apiKey !== "";
            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'k-glow-tracker-vercel';

            // --- 2. è¨ˆç®—å±¬æ€§ (useMemo) ---
            const activePlan = useMemo(() => plans.find(p => p.id === activePlanId) || null, [plans, activePlanId]);
            
            const latestWeight = useMemo(() => {
                const latestFromLogs = activePlan?.workoutEntries?.find(e => e.weight > 0)?.weight;
                return latestFromLogs || activePlan?.baselineWeight || null;
            }, [activePlan]);
            
            const daysLeft = useMemo(() => {
                if (!activePlan) return 0;
                const target = new Date(activePlan.targetDate);
                const today = new Date();
                today.setHours(0,0,0,0); target.setHours(0,0,0,0);
                return Math.max(0, Math.ceil((target - today) / (1000 * 60 * 60 * 24)));
            }, [activePlan]);

            const workoutLogsCount = useMemo(() => activePlan?.workoutEntries?.filter(e => e.date === historyFilterDate).length || 0, [activePlan, historyFilterDate]);
            const dietLogsCount = useMemo(() => activePlan?.dietEntries?.filter(e => e.date === historyFilterDate).length || 0, [activePlan, historyFilterDate]);

            const weekDaysList = useMemo(() => {
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay() + (weekOffset * 7));
                return Array.from({ length: 7 }, (_, i) => {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);
                    return { date: d.toISOString().split('T')[0], label: ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][i], num: d.getDate(), month: d.getMonth() + 1 };
                });
            }, [weekOffset]);

            const todayReinforcement = useMemo(() => {
                const dateObj = new Date(historyFilterDate);
                const dayNum = isNaN(dateObj.getDate()) ? new Date().getDate() : dateObj.getDate();
                return DAILY_REINFORCEMENTS[dayNum % DAILY_REINFORCEMENTS.length];
            }, [historyFilterDate]);

            const historyTotals = useMemo(() => {
                if (!activePlan || !activePlan.dietEntries) return { kcal: 0, p: 0, c: 0, f: 0 };
                return activePlan.dietEntries
                    .filter(e => e.date === historyFilterDate)
                    .reduce((acc, curr) => ({
                        kcal: acc.kcal + (curr.kcal || 0),
                        p: acc.p + (curr.p || 0),
                        f: acc.f + (curr.f || 0),
                        c: acc.c + (curr.c || 0)
                    }), { kcal: 0, p: 0, c: 0, f: 0 });
            }, [activePlan, historyFilterDate]);

            const nutrientInsight = useMemo(() => {
                if (historyTotals.kcal === 0) return "ä»Šå¤©é‚„æ²’æœ‰ç´€éŒ„ç´€éŒ„å–”";
                if (historyTotals.p > 50) return "è›‹ç™½è³ªé”æ¨™ï¼å¦³çš„è‚Œè‚‰æ­£åœ¨å°å¦³å¾®ç¬‘ï¼ğŸ’ª";
                return "æ¯”ä¾‹éå¸¸æ¼‚äº®ï¼å¦³ç°¡ç›´æ˜¯é«”æ…‹ç®¡ç†å¤§å¸«ï¼Œç¹¼çºŒä¿æŒï¼ğŸŒŸ";
            }, [historyTotals]);

            // --- 3. äº‹ä»¶è™•ç†å‡½æ•¸ (ç½®é ‚å®šç¾©) ---
            const dateStats = (dateStr) => {
                if (!activePlan) return { workout: false, diet: false };
                return {
                    workout: (activePlan.workoutEntries || []).some(e => e.date === dateStr && (e.exercises?.length > 0 || e.parts?.length > 0)),
                    diet: (activePlan.dietEntries || []).some(e => e.date === dateStr && (e.breakfast || e.lunch || e.dinner))
                };
            };

            const closeModal = () => { 
                setShowEntryModal(false); setShowPlanModal(false); setEditingId(null); 
                setWNote(''); setWParts([]); setWExercises([]); setDBreakfast(''); setDLunch(''); setDDinner(''); setDSnacks(''); setDWater(2000); 
                setDKcal(0); setDP(0); setDC(0); setDF(0); setDTags([]); setWMood('good');
                setNewPlanTitle(''); setNewPlanDate(''); setNewPlanBaselineWeight(''); setNewPlanTargetWeight('');
            };

            const handleTouchStart = (e) => { touchStartX.current = e.touches[0].clientX; };
            const handleTouchEnd = (e) => {
                if (touchStartX.current === null) return;
                const deltaX = e.changedTouches[0].clientX - touchStartX.current;
                if (deltaX > 50) setWeekOffset(v => v - 1); 
                else if (deltaX < -50) setWeekOffset(v => v + 1); 
                touchStartX.current = null;
            };

            const savePlanToCloud = async (updated) => {
                if (!user || !db || !updated.id) return;
                await setDoc(doc(db, 'artifacts', currentAppId, 'users', user.uid, 'plans', updated.id), updated);
            };

            const handleUpdateWeightOnHome = async (val) => {
              if (!activePlan) return;
              setWWeight(val);
              const weightVal = parseFloat(val);
              if (isNaN(weightVal) || weightVal <= 0) return;
              
              // è§¸ç™¼ç¢ºèªç‰¹æ•ˆ
              setWeightSavedEffect(true);
              setShowCelebration(true);
              
              const today = new Date().toISOString().split('T')[0];
              const entry = { id: Date.now(), date: today, displayDate: `${new Date().getMonth() + 1}æœˆ${new Date().getDate()}æ—¥`, note: 'ä»Šæ—¥ç¨±é‡', parts: [], exercises: [], weight: weightVal, mood: 'good' };
              const updated = [entry, ...(activePlan.workoutEntries || [])].sort((a,b) => new Date(b.date) - new Date(a.date));
              await savePlanToCloud({ ...activePlan, workoutEntries: updated });
              
              setTimeout(() => {
                  setWeightSavedEffect(false);
                  setShowCelebration(false);
              }, 1500);
            };

            const handleCreatePlan = async () => {
                if (!newPlanTitle || !newPlanDate) return;
                const newId = `p-${Date.now()}`;
                const baseline = parseFloat(newPlanBaselineWeight) || 0;
                await savePlanToCloud({ id: newId, title: newPlanTitle, targetDate: newPlanDate, targetWeight: parseFloat(newPlanTargetWeight) || 0, baselineWeight: baseline, workoutEntries: [], dietEntries: [] });
                setActivePlanId(newId); setShowPlanModal(false); setView('home'); setShowGuideModal(true);
            };

            const handleQuickAddFood = (mealSetter, currentVal, foodName) => { 
                const val = currentVal || ""; mealSetter(`${val}${val.trim() ? 'ã€' : ''}${foodName}`); 
            };

            const handleSetQuickDate = (days) => {
                const d = new Date(); d.setDate(d.getDate() + days); setNewPlanDate(d.toISOString().split('T')[0]);
            };

            const handleEditWorkout = (entry) => { 
                setEntryType('workout'); setEditingId(entry.id); setWNote(entry.note || ''); setWParts(entry.parts || []); setWExercises(entry.exercises || []); setWWeight(entry.weight?.toString() || ''); setWDate(entry.date); setWMood(entry.mood || 'good'); setShowEntryModal(true); 
            };
            
            const handleEditDiet = (entry) => { 
                setEntryType('diet'); setEditingId(entry.id); setDBreakfast(entry.breakfast || ''); setDLunch(entry.lunch || ''); setDDinner(entry.dinner || ''); setDSnacks(entry.snacks || ''); setDWater(entry.water || 2000); setDKcal(entry.kcal || 0); setDP(entry.p || 0); setDDate(entry.date); setDTags(entry.tags || []); setShowEntryModal(true); 
            };

            const handleSaveDiet = async () => {
                if (!activePlan) return;
                const entry = { id: editingId || Date.now(), date: d_date, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), breakfast: d_breakfast, lunch: d_lunch, dinner: d_dinner, snacks: d_snacks, water: Number(d_water), kcal: d_kcal, p: d_p, c: d_c, f: d_f, tags: d_tags };
                const list = editingId ? activePlan.dietEntries.map(e => e.id === editingId ? entry : e) : [entry, ...(activePlan.dietEntries || [])];
                await savePlanToCloud({ ...activePlan, dietEntries: list.sort((a,b) => new Date(b.date) - new Date(a.date)) });
                closeModal();
            };

            const handleSaveWorkout = async () => {
                if (!activePlan) return;
                const entry = { id: editingId || Date.now(), date: w_date, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), parts: w_parts, exercises: w_exercises, weight: latestWeight, mood: w_mood };
                const list = editingId ? (activePlan.workoutEntries || []).map(e => e.id === editingId ? entry : e) : [entry, ...(activePlan.workoutEntries || [])];
                await savePlanToCloud({ ...activePlan, workoutEntries: list.sort((a,b) => new Date(b.date) - new Date(a.date)) });
                closeModal();
            };

            const handleCompleteRecommendation = async () => {
                if (!activePlan) return;
                const date = historyFilterDate;
                const newEntry = { id: Date.now(), date: date, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), note: `è£œå¼·æ‰“å¡ï¼š${todayReinforcement.name}`, parts: ['æ ¸å¿ƒ'], exercises: [{ name: todayReinforcement.name, sets: '15x3', category: 'å¢Šä¸Š' }], weight: latestWeight, mood: 'good' };
                await savePlanToCloud({ ...activePlan, workoutEntries: [newEntry, ...(activePlan.workoutEntries || [])].sort((a,b) => new Date(b.date) - new Date(a.date)) });
                setShowCelebration(true);
                setTimeout(() => setShowCelebration(false), 1500);
            };

            const renderTimeline = (entries, type) => {
                const filtered = entries.filter(e => e.date === historyFilterDate);
                if (filtered.length === 0) return <div className="py-20 text-center opacity-40 flex flex-col items-center gap-4 text-muted"><Icon name="calendar-range" size={48}/><p>é€™å¤©é‚„æ²’æœ‰ç›¸é—œç´€éŒ„å–”</p></div>;
                return filtered.map(entry => (
                    <div key={entry.id} className="premium-card p-6 mb-4 active:scale-[0.98] transition-all relative overflow-hidden text-brand" onClick={() => type === 'workout' ? handleEditWorkout(entry) : handleEditDiet(entry)}>
                        <div className="flex justify-between items-center mb-3">
                            <div className="flex items-center gap-2">
                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded-lg uppercase ${type==='workout'?'bg-orange-50 text-accent':'bg-ice text-brand'}`}>{type === 'workout' ? 'è¨“ç·´' : 'é£²é£Ÿ'}</span>
                                {entry.mood && <span className="text-[14px]">{MOOD_OPTIONS.find(m => m.value === entry.mood)?.icon}</span>}
                            </div>
                            <span className="text-[11px] text-muted">{entry.time || '00:00'}</span>
                        </div>
                        {type === 'workout' ? (
                            <div className="space-y-2">{entry.exercises?.map((ex, i) => (<div key={i} className="flex justify-between text-[14px] font-medium border-b border-gray-50 pb-1"><span>{ex.name}</span><span className="text-accent">{ex.sets}</span></div>))}</div>
                        ) : (
                            <div className="space-y-3">
                                <div className="space-y-1">{['breakfast','lunch','dinner','snacks'].map(m => entry[m] && <p key={m} className="text-[14px] leading-relaxed text-brand"><span className="opacity-40 mr-2 text-brand">Â·</span>{entry[m]}</p>)}</div>
                                <div className="flex flex-wrap gap-1 pt-2 border-t border-gray-50">
                                    <span className="bg-blue-50 text-blue-500 text-[9px] font-bold px-2 py-0.5 rounded-full text-brand">P: {entry.p}g</span>
                                    <span className="bg-red-50 text-red-400 text-[9px] font-black px-2 py-0.5 rounded-full text-brand">F: {entry.f}g</span>
                                </div>
                            </div>
                        )}
                    </div>
                ));
            };

            const executeDelete = async () => {
                if (!confirmDelete || !activePlan) return;
                if (confirmDelete.type === 'plan') await deleteDoc(doc(db, 'artifacts', currentAppId, 'users', user.uid, 'plans', confirmDelete.id));
                else {
                    const key = confirmDelete.type === 'workout' ? 'workoutEntries' : 'dietEntries';
                    const updated = activePlan[key].filter(e => e.id !== confirmDelete.id);
                    await savePlanToCloud({ ...activePlan, [key]: updated });
                }
                setConfirmDelete(null);
            };

            // --- Effects ---
            useEffect(() => {
                if (!isConfigReady) { setLoading(false); return; }
                const init = async () => {
                    const appInst = initializeApp(firebaseConfig);
                    const authInst = getAuth(appInst);
                    const dbInst = getFirestore(appInst);
                    setDb(dbInst);
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(authInst, __initial_auth_token);
                    else await signInAnonymously(authInst);
                    onAuthStateChanged(authInst, u => { setUser(u); if(!u) setLoading(false); });
                };
                init();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const unsub = onSnapshot(collection(db, 'artifacts', currentAppId, 'users', user.uid, 'plans'), snap => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setPlans(list.sort((a,b) => new Date(b.targetDate) - new Date(a.targetDate)));
                    setLoading(false);
                }, () => setLoading(false));
                return unsub;
            }, [user, db]);

            if (loading) return <div className="h-full flex flex-col items-center justify-center bg-[#fbfbfe] text-brand gap-4"><Icon name="loader-2" className="animate-spin text-accent" size={32} /><p className="text-[12px] font-bold uppercase tracking-widest text-brand">è³ªæ„Ÿé‡å¡‘ä¸­...</p></div>;

            return (
                <div className={`h-full flex flex-col relative select-none transition-all duration-700 bg-dynamic-flow text-brand`}>
                    
                    {/* æˆåŠŸç‰¹æ•ˆå±¤ */}
                    {showCelebration && (
                        <div className="fixed inset-0 z-[500] flex items-center justify-center pointer-events-none p-4">
                            <div className="bg-white/90 backdrop-blur-xl rounded-[24px] p-8 flex flex-col items-center animate-in zoom-in duration-300 shadow-2xl border border-accent/20">
                                <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mb-4 text-accent"><Icon name="check-circle" size={40} /></div>
                                <h3 className="text-[20px] font-bold">ç´€éŒ„æˆåŠŸï¼âœ¨</h3>
                            </div>
                        </div>
                    )}

                    {/* Header: é¦–é æ•¸æ“šæˆ– TopBar */}
                    <header className="px-4 pt-4 pb-2 z-20 space-y-4 sticky top-0 bg-transparent">
                        {view === 'home' ? (
                            <>
                                <div className="flex justify-between items-start text-brand">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 rounded-full border-2 border-white shadow-xl overflow-hidden"><img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100&h=100&fit=crop" alt="avatar" /></div>
                                        <div className="flex flex-col text-brand text-brand">
                                            <h2 className="text-[16px] font-bold leading-tight mb-1 text-brand">ä½ å¥½, Emma ğŸ‘‹</h2>
                                            {activePlan && latestWeight ? (
                                                <div className="flex items-baseline gap-3 text-brand text-brand">
                                                    <span className="text-[18px] font-black tracking-tighter text-brand">{latestWeight}kg</span>
                                                    <div className="flex items-center gap-2 text-[14px] text-muted font-medium text-brand">
                                                        <span>èµ·å§‹ {activePlan.baselineWeight}kg</span>
                                                        <span className="opacity-20 text-brand">|</span>
                                                        <span className="text-accent font-bold text-brand">ç›®æ¨™ {activePlan.targetWeight}kg</span>
                                                    </div>
                                                </div>
                                            ) : (
                                                <p className="text-[14px] text-muted font-medium">é–‹å§‹å»ºç«‹å¦³çš„ç›®æ¨™è¨ˆç•«å§ï¼âœ¨</p>
                                            )}
                                        </div>
                                    </div>
                                    <div className="text-right text-brand">
                                        <p className="text-[10px] font-black text-muted uppercase tracking-widest mb-0.5 text-brand">å‰©é¤˜å¤©æ•¸</p>
                                        <p className="text-[20px] font-black tracking-tight leading-none text-brand">{daysLeft}</p>
                                    </div>
                                </div>

                                <div 
                                    className="bg-white/20 backdrop-blur-md border border-white/20 rounded-[16px] pt-3 px-4 pb-3 shadow-sm text-brand text-brand"
                                    onTouchStart={handleTouchStart}
                                    onTouchEnd={handleTouchEnd}
                                >
                                    <div className="flex justify-between items-center mb-2 px-1 text-brand text-brand">
                                        <span className="text-[11px] font-bold text-label uppercase tracking-widest text-brand">
                                            {weekDaysList[0].month}æœˆ {weekOffset === 0 ? 'æœ¬é€±' : weekOffset === -1 ? 'ä¸Šé€±' : `${Math.abs(weekOffset)}é€±å‰`}
                                        </span>
                                        <div className="flex gap-2 text-brand">
                                            <button onClick={() => setWeekOffset(v => v - 1)} className="p-1 text-muted active:scale-90 text-brand"><Icon name="chevron-left" size={16}/></button>
                                            <button onClick={() => setWeekOffset(v => v + 1)} className="p-1 text-muted active:scale-90 text-brand" disabled={weekOffset >= 0} style={{opacity: weekOffset >= 0 ? 0.2 : 1}}><Icon name="chevron-right" size={16}/></button>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center px-1 text-brand">
                                        {weekDaysList.map(day => {
                                            const { workout, diet } = dateStats(day.date);
                                            const isSelected = historyFilterDate === day.date;
                                            const isFullyDone = workout && diet;
                                            return (
                                                <div key={day.date} className="flex flex-col items-center gap-1.5 text-brand">
                                                    <span className="text-[10px] font-bold text-muted uppercase tracking-widest text-brand">{day.label}</span>
                                                    <button 
                                                        onClick={() => setHistoryFilterDate(day.date)} 
                                                        className={`calendar-circle ${isFullyDone ? 'fully-completed text-white' : isSelected ? 'selected-border text-accent bg-white/60' : 'bg-[#e9f1fb]/60 text-[#9caeba]'}`}
                                                    >
                                                        {day.num}
                                                        {(workout || diet) && !isFullyDone && <div className="data-indicator-dot text-brand" />}
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="flex items-center h-[44px] px-4 bg-white/20 backdrop-blur-xl rounded-[16px] border border-white/20 text-brand">
                                <h1 className="text-[18px] font-black text-brand tracking-tight">
                                    {view === 'workout_history' && "è¨“ç·´æ—¥èªŒ"}
                                    {view === 'diet_history' && "é£²é£Ÿç´€éŒ„"}
                                    {view === 'plan_manage' && "è¨ˆç•«ç®¡ç†"}
                                </h1>
                            </div>
                        )}
                    </header>

                    <main className="flex-1 overflow-y-auto px-4 no-scrollbar pb-[140px] z-10 text-brand">
                        {view === 'home' ? (
                            <div className="space-y-4">
                                {activePlan ? (
                                    <>
                                      {/* ä¿®æ”¹ï¼šæ™¨é–“ç¨±é‡å–®è¡ŒåŒ–ä¸¦åŠ å…¥ç¢ºèªæŒ‰éˆ•ç‰¹æ•ˆ */}
                                      <section className="premium-card p-4 border border-accent/10 flex items-center justify-between text-brand bg-white/60 backdrop-blur-sm">
                                          <div className="flex items-center gap-4 flex-1">
                                              <div className="w-10 h-10 rounded-xl bg-orange-50 flex items-center justify-center text-accent shadow-inner"><Icon name="scale" size={20} /></div>
                                              <div className="flex-1">
                                                  <p className="text-[11px] font-bold text-label uppercase tracking-widest mb-0.5">æ™¨é–“ç¨±é‡ç´€éŒ„</p>
                                                  <div className="flex items-baseline">
                                                      <input 
                                                          type="number" 
                                                          step="0.1" 
                                                          placeholder={latestWeight || '---'} 
                                                          value={w_weight}
                                                          onChange={(e) => setWWeight(e.target.value)} 
                                                          className="bg-transparent !p-0 !h-[32px] w-24 text-[22px] font-black tracking-tight outline-none text-brand border-none" 
                                                      />
                                                      <span className="text-[12px] font-bold text-muted ml-1">kg</span>
                                                  </div>
                                              </div>
                                          </div>
                                          <button 
                                              onClick={() => handleUpdateWeightOnHome(w_weight)}
                                              className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all ${weightSavedEffect ? 'bg-accent text-white btn-success-anim' : 'bg-ice text-accent active:scale-90'}`}
                                          >
                                              <Icon name={weightSavedEffect ? "check" : "save"} size={20} />
                                          </button>
                                      </section>

                                      <section className="bg-gradient-to-br from-[#a2d53b] to-[#14b8a6] p-6 rounded-[16px] shadow-xl relative overflow-hidden group active:scale-[0.98] transition-all">
                                          <div className="absolute -right-4 -bottom-4 opacity-10 rotate-12 transition-transform group-hover:scale-110 text-white"><Icon name="trophy" size={120} /></div>
                                          <div className="flex justify-between items-start text-white text-brand">
                                              <div>
                                                  <div className="bg-white/20 backdrop-blur-md rounded-full px-3 py-1 text-[10px] font-black mb-3 inline-block uppercase tracking-widest text-white text-brand">ä»Šæ—¥è£œå¼·é‡é»</div>
                                                  <h2 className="text-[20px] font-black leading-tight mb-1.5 text-white">{todayReinforcement.name}</h2>
                                                  <p className="opacity-90 text-[13px] leading-relaxed pr-6 line-clamp-2 text-white">{todayReinforcement.desc}</p>
                                              </div>
                                              <button onClick={handleCompleteRecommendation} className="w-12 h-12 bg-white rounded-[16px] flex items-center justify-center text-[#14b8a6] shadow-xl active:scale-90 transition-all font-black text-[12px] uppercase tracking-widest">é–‹å§‹</button>
                                          </div>
                                      </section>

                                      <div className="grid grid-cols-2 gap-4 text-brand text-brand">
                                          <button onClick={() => setView('workout_history')} className="premium-card p-5 flex flex-col items-center gap-3 active:scale-95 transition-all text-brand">
                                              <div className="w-12 h-12 rounded-[16px] bg-orange-50 flex items-center justify-center text-accent shadow-inner"><Icon name="dumbbell" size={24}/></div>
                                              <div className="text-center text-brand">
                                                  <p className="text-[14px] font-black">è¨“ç·´æ—¥èªŒ</p>
                                                  <div className={`mt-1 px-3 py-0.5 rounded-full text-[10px] font-bold ${workoutLogsCount > 0 ? 'bg-orange-100 text-accent' : 'bg-gray-100 text-muted'}`}>ä»Šæ—¥ {workoutLogsCount} ç­†</div>
                                              </div>
                                          </button>
                                          <button onClick={() => setView('diet_history')} className="premium-card p-5 flex flex-col items-center gap-3 active:scale-95 transition-all text-brand">
                                              <div className="w-12 h-12 rounded-[16px] bg-blue-50 flex items-center justify-center text-brand shadow-inner text-brand"><Icon name="utensils" size={24}/></div>
                                              <div className="text-center text-brand">
                                                  <p className="text-[14px] font-black">é£²é£Ÿç´€éŒ„</p>
                                                  <div className={`mt-1 px-3 py-0.5 rounded-full text-[10px] font-bold ${dietLogsCount > 0 ? 'bg-blue-100 text-brand' : 'bg-gray-100 text-muted'}`}>ä»Šæ—¥ {dietLogsCount} ç­†</div>
                                              </div>
                                          </button>
                                      </div>
                                    </>
                                ) : (
                                    <section onClick={() => setShowPlanModal(true)} className="premium-card p-10 flex flex-col items-center justify-center gap-6 bg-white/60 backdrop-blur-sm border-2 border-dashed border-muted/30 active:scale-[0.98] transition-all text-brand text-brand">
                                        <div className="w-16 h-16 bg-accent/10 rounded-full flex items-center justify-center text-accent text-brand"><Icon name="flag" size={32} /></div>
                                        <div className="text-center space-y-2 text-brand">
                                            <h2 className="text-[18px] font-black text-brand">æ­¡è¿ä¾†åˆ° K-Glow âœ¨</h2>
                                            <p className="text-[13px] text-muted px-4 text-brand">è«‹å…ˆè¨­å®šå¦³çš„é«”é‡ç›®æ¨™ï¼Œè®“æˆ‘å€‘é™ªä¼´å¦³ä¸€èµ·è®Šç¾è®Šå¼·ï¼</p>
                                        </div>
                                        <button className="h-[44px] px-8 bg-brand text-white rounded-[16px] font-black shadow-lg transition-all text-white text-brand">å»ºç«‹ç¬¬ä¸€ä»½è¨ˆç•«</button>
                                    </section>
                                )}
                            </div>
                        ) : (
                            <div className="space-y-6 text-brand">
                                {view === 'plan_manage' ? (
                                    <div className="space-y-4">
                                        <button onClick={() => setShowPlanModal(true)} className="w-full h-[44px] bg-[#e9f1fb] rounded-[16px] border-2 border-dashed border-muted/30 flex items-center justify-center gap-2 active:scale-95 text-brand text-brand">
                                            <Icon name="plus" size={20} className="text-accent"/><span className="font-black text-[14px] uppercase tracking-widest text-brand">å»ºç«‹ç›®æ¨™è¨ˆç•«</span>
                                        </button>
                                        {plans.map(p => (
                                            <div key={p.id} className={`premium-card p-6 border-l-8 ${activePlanId === p.id ? 'border-accent shadow-lg' : 'border-muted/20'} text-brand`}>
                                                <div className="flex justify-between items-start mb-4 text-brand text-brand text-brand">
                                                    <div><h3 className="text-[17px] font-black tracking-tight text-brand">{p.title}</h3><p className="text-[11px] font-bold text-muted text-brand">{p.targetDate} æ­¢</p></div>
                                                    <button onClick={() => { setConfirmDelete({type:'plan', id: p.id}); }} className="p-2 text-red-200 active:scale-90 text-brand text-brand"><Icon name="trash-2" size={18}/></button>
                                                </div>
                                                {activePlanId !== p.id && <button onClick={() => {setActivePlanId(p.id); setView('home');}} className="w-full h-[44px] bg-brand text-white rounded-xl font-black text-[12px] active:scale-95 transition-all shadow-lg text-white text-brand">å•Ÿå‹•è¨ˆç•«</button>}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-brand">
                                        {view === 'diet_history' && (
                                            <div className="space-y-4 mb-8 text-brand text-brand text-brand">
                                                <h3 className="text-[18px] font-black ml-1 tracking-tight text-brand">é£²é£Ÿç‡Ÿé¤Šæ¦‚æ³</h3>
                                                <div className="flex gap-4 overflow-x-auto no-scrollbar px-1 pb-4 text-brand">
                                                    <div className="nutrition-card text-white text-brand">
                                                        <Icon name="flame" size={24} className="text-red-500" fill="#ef4444" />
                                                        <div><p className="text-[11px] font-black opacity-60 uppercase mb-1 text-white text-brand">ç†±é‡</p><p className="text-[20px] font-black text-white text-brand">{historyTotals.kcal}<span className="text-[10px] ml-1 text-brand text-brand">Kcal</span></p></div>
                                                    </div>
                                                    <div className="nutrition-card text-white text-brand">
                                                        <Icon name="dna" size={24} className="text-blue-400" fill="#60a5fa" />
                                                        <div><p className="text-[11px] font-black opacity-60 uppercase mb-1 text-white text-brand">è›‹ç™½è³ª</p><p className="text-[20px] font-black text-white text-brand">{historyTotals.p}<span className="text-[10px] ml-1 text-white text-brand">g</span></p></div>
                                                    </div>
                                                    <div className="nutrition-card text-white text-brand text-brand">
                                                        <Icon name="droplet" size={24} className="text-yellow-400" fill="#fbbf24" />
                                                        <div><p className="text-[11px] font-black opacity-60 uppercase mb-1 text-white text-brand">è„‚è‚ª</p><p className="text-[20px] font-black text-white text-white text-brand">{historyTotals.f}<span className="text-[10px] ml-1 text-white text-white text-brand">g</span></p></div>
                                                    </div>
                                                </div>
                                                <div className="bg-ice rounded-3xl p-5 border border-[#9caeba]/20 shadow-sm text-brand text-brand text-brand">
                                                    <p className="text-[14px] font-bold leading-relaxed italic text-[#040316]/70 text-brand">ã€Œ{nutrientInsight}ã€</p>
                                                </div>
                                            </div>
                                        )}
                                        <div className="flex items-center gap-2 px-1 py-4 text-muted uppercase font-black tracking-widest text-[12px] text-brand text-brand"><Icon name="calendar" size={16}/>{historyFilterDate} {view === 'workout_history' ? 'è¨“ç·´æ­·å²' : 'é£²é£Ÿç´€éŒ„'}</div>
                                        {renderTimeline(view === 'workout_history' ? activePlan?.workoutEntries || [] : activePlan?.dietEntries || [], view === 'workout_history' ? 'workout' : 'diet')}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* å³¶å¶¼å°è¦½åˆ— */}
                    <nav className="island-navbar">
                        <div className="flex flex-1 justify-around items-center text-brand">
                            <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1 transition-all ${view === 'home' ? 'text-accent scale-110' : 'text-muted opacity-40'}`}><Icon name="home" size={22} fill={view === 'home' ? 'currentColor' : 'none'} /><span className="text-[9px] font-black uppercase tracking-widest text-brand text-brand">é¦–é </span></button>
                            <button onClick={() => setView('workout_history')} className={`flex flex-col items-center gap-1 transition-all ${view === 'workout_history' ? 'text-accent scale-110' : 'text-muted opacity-40'}`}><Icon name="activity" size={22} /><span className="text-[9px] font-black uppercase tracking-widest text-brand text-brand">ç´€éŒ„</span></button>
                        </div>
                        <div className="px-2 text-brand">
                            <button onClick={() => {setEntryType('workout'); setEditingId(null); setShowEntryModal(true);}} className="glow-action-btn text-brand text-brand">GO!</button>
                        </div>
                        <div className="flex flex-1 justify-around items-center text-brand">
                            <button onClick={() => setView('diet_history')} className={`flex flex-col items-center gap-1 transition-all ${view === 'diet_history' ? 'text-accent scale-110' : 'text-muted opacity-40'}`}><Icon name="utensils" size={22} /><span className="text-[9px] font-black uppercase tracking-widest text-brand">é£²é£Ÿ</span></button>
                            <button onClick={() => setView('plan_manage')} className={`flex flex-col items-center gap-1 transition-all ${view === 'plan_manage' ? 'text-accent scale-110' : 'text-muted opacity-40'}`}><Icon name="clipboard" size={22} /><span className="text-[9px] font-black uppercase tracking-widest text-brand text-brand">è¨ˆç•«</span></button>
                        </div>
                    </nav>

                    {/* Entry Modal - é¸ä¸­æ´»åŠ›æ©˜ 75% Height */}
                    {showEntryModal && (
                        <div className="absolute inset-0 z-[100] flex items-end animate-in fade-in duration-300 text-brand">
                            <div className="absolute inset-0 bg-[#040316]/30 backdrop-blur-sm" onClick={closeModal} />
                            <div className="w-full bg-white rounded-t-[16px] h-[75vh] z-10 flex flex-col animate-in slide-in-from-bottom-full duration-500 shadow-2xl overflow-hidden border-t border-white text-brand text-brand">
                                <header className="h-[44px] px-4 border-b border-gray-50 flex justify-between items-center bg-white sticky top-0 z-20 text-brand">
                                    <div className="w-10"></div>
                                    <div className="flex bg-gray-100 p-1 rounded-[16px] text-brand">
                                        <button onClick={() => setEntryType('workout')} className={`px-8 h-[28px] rounded-[12px] text-[12px] font-black transition-all ${entryType === 'workout' ? 'bg-white text-brand shadow-sm' : 'text-muted'}`}>é‹å‹•</button>
                                        <button onClick={() => setEntryType('diet')} className={`px-8 h-[28px] rounded-[12px] text-[12px] font-black transition-all ${entryType === 'diet' ? 'bg-white text-brand shadow-sm' : 'text-muted'}`}>é£²é£Ÿ</button>
                                    </div>
                                    <button onClick={closeModal} className="text-muted active:scale-90 p-2 text-brand"><Icon name="x" size={20}/></button>
                                </header>
                                <div className="flex-1 overflow-y-auto p-4 space-y-[24px] no-scrollbar pb-32 text-brand">
                                    <div className="space-y-[12px] text-brand text-brand text-brand">
                                        <p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">ç´€éŒ„æ—¥æœŸ</p>
                                        <div className="bg-gray-100 rounded-[16px] px-[12px] h-[40px] flex items-center text-brand text-brand"><input type="date" value={entryType==='workout'?w_date:d_date} onChange={e=>entryType==='workout'?setWDate(e.target.value):setDDate(e.target.value)} className="w-full font-bold text-accent bg-transparent outline-none !px-0 text-brand" /></div>
                                    </div>
                                    
                                    {entryType === 'workout' ? (
                                        <div className="space-y-[24px] text-brand text-brand">
                                            <div className="space-y-[12px] text-brand text-brand text-brand text-brand"><p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">è¨“ç·´å¿ƒæƒ…</p><div className="flex justify-between gap-3 text-brand">{MOOD_OPTIONS.map(m => (<button key={m.value} onClick={()=>setWMood(m.value)} className={`flex-1 flex flex-col items-center justify-center h-[72px] rounded-[16px] border-2 transition-all ${w_mood === m.value ? 'bg-accent text-white border-accent shadow-xl shadow-orange-100' : 'bg-white border-gray-100 text-muted'}`}><span className="text-[20px] mb-1">{m.icon}</span><span className="text-[9px] font-black uppercase text-brand text-brand">{m.label}</span></button>))}</div></div>
                                            <div className="space-y-[12px] text-brand text-brand text-brand text-brand text-brand"><p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand text-brand">è¨“ç·´éƒ¨ä½</p><div className="flex gap-3 flex-wrap text-brand">{BODY_PARTS.map(p => <button key={p} onClick={() => setWParts(v => v.includes(p) ? v.filter(i=>i!==p) : [...v,p])} className={`px-5 h-[44px] rounded-[16px] text-[14px] font-black border-2 transition-all ${w_parts.includes(p) ? 'bg-accent text-white border-accent shadow-lg' : 'bg-white border-gray-100 text-muted'}`}>{p}</button>)}</div></div>
                                            <div className="space-y-[12px] text-brand text-brand text-brand">
                                                <p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">å‹•ä½œé¸æ“‡</p>
                                                <div className="bg-gray-50 rounded-[16px] p-5 space-y-5 border border-gray-100 text-brand">
                                                    {Object.keys(EXERCISE_LIBRARY).map(t => (<div key={t} className="space-y-3 text-brand text-brand text-brand"><p className="text-[10px] font-black opacity-30 uppercase tracking-[2px] text-brand">{t}</p><div className="grid grid-cols-1 gap-2.5 text-brand">{EXERCISE_LIBRARY[t].map(ex => { 
                                                        const idx = w_exercises.findIndex(i => i.name === ex.name && i.category === t); const active = idx !== -1;
                                                        return (<div key={ex.name} className={`premium-card p-4 transition-all ${active ? 'border-accent bg-white shadow-md' : 'opacity-70 bg-white/50'} text-brand`} onClick={() => active ? setWExercises(v=>v.filter(i=>!(i.name===ex.name && i.category===t))) : setWExercises([...w_exercises, { name: ex.name, sets: '15x3', category: t }])}><div className="flex justify-between items-center text-brand text-brand text-brand text-brand text-brand text-brand"><div className="flex items-center gap-3 text-brand text-brand text-brand"><div className={`w-9 h-9 rounded-[12px] flex items-center justify-center transition-all ${active ? 'bg-accent text-white shadow-md' : 'bg-gray-100'}`}>{active ? <Icon name="check" size={18}/> : <Icon name="plus" size={18}/>}</div><p className="text-[14px] font-black text-brand text-brand">{ex.name}</p></div><Icon name="youtube" size={18} className="text-red-400" onClick={(e)=>{e.stopPropagation(); window.open(`https://www.youtube.com/results?search_query=pilates+${ex.name.split(' (')[0]}`, '_blank');}} /></div>{active && <input type="text" value={w_exercises[idx].sets} onChange={e=>setWExercises(w_exercises.map((item, i) => i === idx ? {...item, sets: e.target.value} : item))} onClick={e=>e.stopPropagation()} className="mt-3 !bg-gray-100 !h-[40px] text-[13px] font-black rounded-[12px] !px-[12px] text-brand text-brand" placeholder="è¨­å®šçµ„çµ„æ•¸" />}</div>)
                                                    })}</div></div>))}
                                                </div>
                                            </div>
                                            <div className="space-y-[12px] text-brand text-brand text-brand"><p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">è¨“ç·´ç­†è¨˜</p><textarea value={w_note} onChange={e=>setWNote(e.target.value)} className="w-full h-32 bg-ingray rounded-[16px] p-[12px] text-[14px] border-none outline-none resize-none text-brand text-brand" placeholder="è¨˜éŒ„ä»Šå¤©çš„æ„Ÿå—..." /></div>
                                        </div>
                                    ) : (
                                        <div className="space-y-[24px] text-brand text-brand text-brand">
                                            <div className="flex items-center justify-between premium-card p-6 bg-blue-50 border-none text-brand">
                                                <div className="flex items-center gap-4 text-brand text-brand"><Icon name="droplets" size={28} className="text-accent" /><div className="flex items-baseline text-brand"><input type="number" value={d_water} onChange={e=>setDWater(e.target.value)} className="w-24 bg-transparent text-[36px] font-black tracking-tighter outline-none !px-[12px] text-brand text-brand" /><span className="text-[14px] font-black text-muted ml-1 text-brand">cc</span></div></div>
                                                <div className="flex gap-3 text-brand text-brand"><button onClick={()=>setDWater(Math.max(0,Number(d_water)-250))} className="w-11 h-11 bg-white rounded-full border border-gray-200 shadow-sm active:scale-90 font-black text-brand">-</button><button onClick={()=>setDWater(Number(d_water)+250)} className="w-11 h-11 bg-accent text-white rounded-full shadow-md active:scale-90 font-black text-brand">+</button></div>
                                            </div>
                                            {['breakfast', 'lunch', 'dinner', 'snacks'].map(meal => {
                                                const setters = { breakfast: setDBreakfast, lunch: setDLunch, dinner: setDDinner, snacks: setDSnacks };
                                                const vals = { breakfast: d_breakfast, lunch: d_lunch, dinner: d_dinner, snacks: d_snacks };
                                                const mealNames = { breakfast: 'æ—©é¤', lunch: 'åˆé¤', dinner: 'æ™šé¤', snacks: 'é»å¿ƒ' };
                                                return (<div key={meal} className="space-y-[12px] text-brand text-brand text-brand"><p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">{mealNames[meal]}</p><textarea value={vals[meal]} onChange={e=>setters[meal](e.target.value)} className="w-full h-24 shadow-none bg-gray-50 rounded-[16px] p-[12px] text-brand text-brand" placeholder="ç´€éŒ„å…§å®¹..." /></div>)
                                            })}
                                            <div className="space-y-[12px] text-brand text-brand"><p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">é£²é£Ÿæ¨™ç±¤</p><div className="flex gap-3 flex-wrap text-brand">{DIET_TAGS.map(t => <button key={t} onClick={()=>setDTags(prev => prev.includes(t) ? prev.filter(x=>x!==t) : [...prev, t])} className={`px-5 h-[44px] rounded-[16px] text-[14px] font-black border-2 transition-all text-brand ${d_tags.includes(t) ? 'bg-accent text-white border-accent shadow-md shadow-orange-100' : 'bg-white border-gray-100 text-muted'}`}>{t}</button>)}</div></div>
                                        </div>
                                    )}
                                </div>
                                <div className="absolute bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-gray-100 pb-12 z-30 text-brand">
                                    <button onClick={entryType === 'workout' ? handleSaveWorkout : handleSaveDiet} disabled={!activePlan || (entryType === 'diet' ? !isDietValid : !isWorkoutValid)} className={`w-full h-[44px] rounded-[16px] text-white font-black text-[16px] shadow-lg active:scale-95 transition-all text-white disabled:opacity-30 ${entryType === 'workout' ? 'bg-accent shadow-orange-200' : 'bg-brand'}`}>å„²å­˜ä»Šæ—¥ç´€éŒ„</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* New Plan Modal */}
                    {showPlanModal && (
                        <div className="absolute inset-0 z-[120] flex items-end animate-in fade-in duration-300 text-brand">
                            <div className="absolute inset-0 bg-[#040316]/30 backdrop-blur-sm" onClick={() => setShowPlanModal(false)} />
                            <div className="w-full bg-white rounded-t-[16px] h-[75vh] z-10 flex flex-col animate-in slide-in-from-bottom-full duration-500 shadow-2xl overflow-hidden border-t border-white text-brand text-brand">
                                <header className="h-[44px] px-6 border-b border-gray-50 flex justify-between items-center bg-white text-brand">
                                    <div className="w-10"></div>
                                    <h3 className="text-[17px] font-black tracking-tight text-brand">å•Ÿå‹•æ–°è¨ˆç•«</h3>
                                    <button onClick={() => setShowPlanModal(false)} className="p-2 text-muted active:scale-90 text-brand"><Icon name="x" size={20}/></button>
                                </header>
                                
                                <div className="flex-1 overflow-y-auto p-6 space-y-[24px] no-scrollbar pb-44 text-brand">
                                    <div className="space-y-[12px] text-brand text-brand"><p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">è¨ˆç•«åç¨±</p><input value={newPlanTitle} onChange={e=>setNewPlanTitle(e.target.value)} className="w-full !bg-gray-100 h-[40px] rounded-[16px] !px-[12px] font-bold text-brand" placeholder="ä¾‹å¦‚ï¼šé¦–çˆ¾ 14 å¤©è¡åˆº" /></div>
                                    <div className="space-y-[12px] text-brand text-brand text-brand">
                                        <p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">ç›®æ¨™æ—¥æœŸ</p>
                                        <div className="bg-gray-100 rounded-[16px] px-[12px] shadow-none h-[40px] flex items-center text-brand text-brand"><input type="date" value={newPlanDate} onChange={e=>setNewPlanDate(e.target.value)} className="w-full font-bold text-accent bg-transparent outline-none !px-0 text-brand" /></div>
                                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 text-brand">
                                            {[7, 14, 30, 90].map(days => (
                                                <button key={days} onClick={() => handleSetQuickDate(days)} className="quick-period-btn text-brand">
                                                    {days}å¤©
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 text-brand text-brand">
                                        <div className="space-y-[12px] text-brand text-brand text-brand"><p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">èµ·å§‹é«”é‡ (kg)</p><input type="number" step="0.1" value={newPlanBaselineWeight} onChange={e=>setNewPlanBaselineWeight(e.target.value)} className="w-full !bg-gray-100 h-[40px] rounded-[16px] !px-[12px] font-black text-[22px] tracking-tighter text-brand" placeholder="57.0" /></div>
                                        <div className="space-y-[12px] text-brand text-brand text-brand text-brand"><p className="text-[16px] font-bold text-label uppercase tracking-widest text-brand">ç›®æ¨™é«”é‡ (kg)</p><input type="number" step="0.1" value={newPlanTargetWeight} onChange={e=>setNewPlanTargetWeight(e.target.value)} className="w-full !bg-gray-100 h-[40px] rounded-[16px] !px-[12px] font-black text-accent text-[22px] tracking-tighter text-brand" placeholder="54.0" /></div>
                                    </div>
                                </div>
                                <div className="absolute bottom-0 left-0 right-0 p-6 bg-white/95 backdrop-blur-md border-t border-gray-100 pb-10 z-30 text-brand">
                                    <div className="flex gap-4 text-brand text-brand">
                                        <button onClick={() => setShowPlanModal(false)} className="flex-1 h-[44px] bg-gray-50 border border-gray-200 rounded-[16px] text-muted font-bold active:scale-95 text-brand">å–æ¶ˆ</button>
                                        <button onClick={handleCreatePlan} disabled={!newPlanTitle || !newPlanDate} className="flex-1 h-[44px] bg-accent text-white rounded-[16px] font-black shadow-lg active:scale-95 transition-all text-white text-brand">ç«‹å³å•Ÿå‹•</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
