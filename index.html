<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>K-Glow Tracker</title>
    <!-- ÂºïÂÖ•Ê†∏ÂøÉÂ∫´ -->
    <script src="https://cdn.tailwindcss.com/"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        :root {
            --bg-color: #fbfbfe;
            --text-color: #040316; 
            --accent-color: #f9991a; 
            --gray-blue: #5a6a7a;
            --muted-gray: #9caeba;
            --radius-standard: 16px; 
            --ice-blue: rgba(233, 241, 251, 0.5);
        }

        body {
            font-family: 'PingFang TC', 'Poppins', 'Noto Sans TC', sans-serif;
            background-color: #e5e7eb;
            margin: 0;
            display: flex;
            justify-content: center;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-color);
        }

        #root {
            width: 100%;
            max-width: 430px; 
            height: 100vh;
            height: 100dvh; 
            background-color: var(--bg-color);
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            background-image: url('https://raw.githubusercontent.com/Minpi-0/Health-Tracker/main/img/bg-mainpage.svg');
            background-size: cover;
            background-position: center;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .premium-card {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-standard);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .tag-btn {
            padding: 0 16px; height: 36px; border-radius: 12px;
            font-size: 14px; font-weight: 700; border: 1px solid #e2e8f0;
            background-color: white; color: var(--muted-gray);
            transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 4px;
        }
        .tag-btn.active { background-color: var(--accent-color); border-color: var(--accent-color); color: white; }

        .equipment-block { background-color: #f1f5f9; border-radius: var(--radius-standard); padding: 12px; margin-top: 8px; }
        .exercise-item-card { background-color: white; border-radius: var(--radius-standard); padding: 10px; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.02); transition: all 0.2s ease; margin-bottom: 8px; border: 1px solid transparent; }
        .exercise-item-card.active { border-color: rgba(249, 153, 26, 0.3); background-color: #fffaf5; }

        .stepper-btn { width: 32px; height: 32px; background-color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--gray-blue); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .note-textarea { height: 60px !important; min-height: 60px !important; padding: 12px !important; font-size: 14px; line-height: 1.5; border-radius: 12px; width: 100%; outline: none; border: none; }

        button.primary-btn { height: 48px; border-radius: var(--radius-standard); font-size: 15px; font-weight: 700; background-color: var(--accent-color) !important; color: white !important; box-shadow: 0 4px 15px rgba(249, 153, 26, 0.3); border: none; }
        button.primary-btn:disabled { opacity: 0.7; background-color: #cbd5e1 !important; }

        .status-circle { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.2s; }

        .island-navbar {
            position: absolute; bottom: 16px; left: 16px; right: 16px; height: 76px;
            background: rgba(255, 255, 255, 0.98); border-radius: 20px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        
        .glow-action-btn {
            width: 72px; height: 72px; background: linear-gradient(135deg, #fbbf24, #f9991a);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; box-shadow: 0 8px 25px rgba(249, 153, 26, 0.4);
            transform: translateY(-24px); border: 4px solid white;
        }

        .sheet-container { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: flex-end; justify-content: center; pointer-events: none; }
        .sheet-backdrop { position: absolute; inset: 0; background: rgba(4, 3, 22, 0.4); backdrop-filter: blur(4px); pointer-events: auto; }
        .sheet-content {
            position: relative; z-index: 1010; width: 100%; max-width: 430px; background: white;
            border-top-left-radius: 24px; border-top-right-radius: 24px; 
            max-height: 90vh; overflow: hidden;
            display: flex; flex-direction: column; pointer-events: auto; animation: slide-up 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fade-scale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }

        .modal-center-content { animation: fade-scale 0.2s ease-out; pointer-events: auto; }

        .nutrient-bar-bg { height: 4px; background: #f1f5f9; border-radius: 10px; width: 100%; overflow: hidden; display: flex; gap: 2px; }
        .bar-p { background: #f9991a; height: 100%; }
        .bar-f { background: #9caeba; height: 100%; }
        .bar-c { background: #5a6a7a; height: 100%; }

        .timeline-date-chip { display: inline-block; padding: 4px 16px; background: white; border: 1px solid #e2e8f0; border-radius: 100px; font-size: 12px; font-weight: 800; color: #5a6a7a; margin-bottom: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }

        .touch-target { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .margin-consistency { margin-bottom: 16px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // Firebase Ë®≠ÂÆöÈ†êÁïô‰Ωç
        const myFirebaseConfig = {
            apiKey: "AIzaSyBpCw2-cfSDaE0ABznkvULKD9sxgjlR9OI", // ‰æãÂ¶Ç: "AIzaSy..."
            authDomain: "health-tracker-ed193.firebaseapp.com",
            projectId: "health-tracker-ed193",
            storageBucket: "health-tracker-ed193.firebasestorage.app",
            messagingSenderId: "77615585267",
            appId: "1:77615585267:web:451f6672cc9834dc92a486"
        };

        // --- 1. Icon ÂÖÉ‰ª∂ ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (window.lucide && wrapperRef.current) {
                    wrapperRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({ root: wrapperRef.current, attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={wrapperRef} className={`inline-flex items-center justify-center shrink-0 ${className}`} />;
        };

        // --- 2. AI ÊèõÁÆóÈÇèËºØ ---
        const apiKey = ""; 
        const fetchBatchNutritionData = async (fullText) => {
            if (!fullText) return { kcal: 0, p: 0, f: 0, c: 0 };
            const systemPrompt = "Â¶≥ÊòØ‰∏Ä‰ΩçÂ∞àÊ•≠ÁáüÈ§äÂ∏´„ÄÇË´ãË®àÁÆóÈ£≤È£üÊ∏ÖÂñÆÁöÑ„ÄéÁ∏ΩÁµê„ÄèÁáüÈ§äÔºöÁÜ±Èáè(kcal)„ÄÅËõãÁôΩË≥™(g)„ÄÅËÑÇËÇ™(g)„ÄÅÁ¢≥Ê∞¥(g)„ÄÇË´ãÂè™ÂõûÂÇ≥ JSON Ê†ºÂºèÔºö{\"kcal\": Êï∏ÂÄº, \"p\": Êï∏ÂÄº, \"f\": Êï∏ÂÄº, \"c\": Êï∏ÂÄº}„ÄÇ";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `ÂÖßÂÆπÔºö${fullText}` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return text ? JSON.parse(text) : { kcal: 0, p: 0, f: 0, c: 0 };
            } catch (err) { return { kcal: 0, p: 0, f: 0, c: 0 }; }
        };

        const BODY_PARTS = ['Ê†∏ÂøÉ', '‰∏äÂçäË∫´', '‰∏ãÂçäË∫´', 'ÂÖ®Ë∫´ÊµÅÂãï'];
        const PILATES_DATABASE = {
          "Ê†∏ÂøÉÂ∫ä (REFORMER)": ["Ë∂≥ÈÉ®Á∑¥Áøí", "ËÖøÈÉ®ÂúàÂúì", "Â§ßË±°Âºè", "Áü≠ÁÆ±Á≥ªÂàó", "ËÉåÈÉ®ÂàíËàπ"],
          "Âá±Ëø™ÊãâÂÖã (CADILLAC)": ["Êç≤Ë∫´‰∏ãÂ£ì", "Êé®Ê£íÈÅãÂãï", "Áå¥Â≠êÂºè", "ÂΩàÁ∞ßËÖøÂúà", "Â°îÂºèÈÅãÂãï"],
          "Á©©Ë∏èÊ§Ö (CHAIR)": ["Ë∏èÊùøÁ∑¥Áøí", "ÂºìÁÆ≠ÊâãÂºè", "Â§©ÈµùÂºè", "ÁôªÂ±±ËÄÖ", "Ê¥æÂÖãÂºè"],
          "Â¢ä‰∏ä / Ê¢ØÊ°∂ (MAT / BARREL)": ["‰∏ÄÁôæÊ¨°ÂëºÂê∏", "Êç≤Ë∫´‰∏äÊèö", "ÂñÆËÖø‰º∏Â±ï", "Â§©ÈµùË∑≥Ê∞¥", "È®éÈ¶¨Âºè"]
        };
        const DAILY_REINFORCEMENTS = [
          { name: 'Ê≠ªËü≤Âºè', sets: 3, reps: 12, explanation: 'Á©©ÂÆöÊ∑±Â±§Ê†∏ÂøÉ„ÄÇ' },
          { name: 'Ë≤ìÁâõÂºè', sets: 3, reps: 15, explanation: 'ÈáãÊîæËÖ∞ËÉåÂ£ìÂäõ„ÄÇ' },
          { name: 'È≥•ÁãóÂºè', sets: 3, reps: 10, explanation: 'Ë®ìÁ∑¥Â∞çÂÅ¥Âπ≥Ë°°„ÄÇ' }
        ];

        const App = () => {
            const [view, setView] = useState('home');
            const [plans, setPlans] = useState([]);
            const [activePlanId, setActivePlanId] = useState(null);
            
            // UI ÊéßÂà∂
            const [showEntryModal, setShowEntryModal] = useState(false);
            const [showPlanModal, setShowPlanModal] = useState(false);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [confirmAction, setConfirmAction] = useState(null);
            
            const [entryType, setEntryType] = useState('workout');
            const [historyFilterDate, setHistoryFilterDate] = useState(new Date().toISOString().split('T')[0]);
            const [weekOffset, setWeekOffset] = useState(0);

            // Ëá™Ë®ÇÂø´Êç∑È£üÁâ©
            const [quickFoods, setQuickFoods] = useState({ 
                breakfast: ["ÁÑ°Á≥ñË±ÜÊºø", "Ê∞¥ÁÖÆËõã", "Âú∞Áìú"], 
                lunch: ["ËàíËÇ•ÈõûËÉ∏", "ÂÅ•Â∫∑È§êÁõí", "Ê≤ôÊãâ"], 
                dinner: ["ÁáôÈùíËèú", "ÁÖéË±ÜËÖê", "Á≥ôÁ±≥È£Ø"], 
                snacks: ["Á∂úÂêàÂ†ÖÊûú", "ÂÑ™Ê†º", "ËõãÁôΩÈ£≤"]
            });
            const [customFoodInput, setCustomFoodInput] = useState({ breakfast: '', lunch: '', dinner: '', snacks: '' });

            // Á¥ÄÈåÑË°®ÂñÆÊï∏Êìö
            const [editingId, setEditingId] = useState(null);
            const [w_date, setWDate] = useState(new Date().toISOString().split('T')[0]);
            const [d_date, setDDate] = useState(new Date().toISOString().split('T')[0]);
            const [w_parts, setWParts] = useState([]);
            const [w_category, setWCategory] = useState("Ê†∏ÂøÉÂ∫ä (REFORMER)");
            const [w_exercises, setWExercises] = useState([]);
            const [w_note, setWNote] = useState('');
            const [w_weight, setWWeight] = useState('');
            const [isEditingWeight, setIsEditingWeight] = useState(false);
            const [confirmAnim, setConfirmAnim] = useState(false);

            const [dietForm, setDietForm] = useState({ breakfast: '', lunch: '', dinner: '', snacks: '' });
            const [d_water, setDWater] = useState(200);
            const [isSaving, setIsSaving] = useState(false);

            const [editingPlanId, setEditingPlanId] = useState(null);
            const [newPlanTitle, setNewPlanTitle] = useState('');
            const [newPlanDate, setNewPlanDate] = useState('');
            const [newPlanBaselineWeight, setNewPlanBaselineWeight] = useState('');
            const [newPlanTargetWeight, setNewPlanTargetWeight] = useState('');

            // --- Ê†∏ÂøÉÈÅãÁÆóÂáΩÂºè (‰øÆÂæ©È†ÜÂ∫èÔºåÁ¢∫‰øùÂú®ÊëòË¶ÅË®àÁÆóÂâçÂèØÁî®) ---
            const getDayDietTotals = (date) => {
                const targetPlan = plans.find(p => p.id === activePlanId);
                const dayEntries = targetPlan?.dietEntries?.filter(e => e.date === date) || [];
                return dayEntries.reduce((acc, curr) => ({
                    kcal: acc.kcal + (Number(curr.kcal) || 0),
                    p: acc.p + (Number(curr.p) || 0),
                    f: acc.f + (Number(curr.f) || 0),
                    c: acc.c + (Number(curr.c) || 0),
                    water: acc.water + (Number(curr.water) || 0)
                }), { kcal: 0, p: 0, f: 0, c: 0, water: 0 });
            };

            const getDayWorkoutTotals = (date) => {
                const targetPlan = plans.find(p => p.id === activePlanId);
                const dayEntries = targetPlan?.workoutEntries?.filter(e => e.date === date) || [];
                return dayEntries.length;
            };

            const dateStats = (dateStr) => {
                const targetPlan = plans.find(p => p.id === activePlanId);
                if (!targetPlan) return { workout: false, diet: false };
                return {
                    workout: (targetPlan.workoutEntries || []).some(e => e.date === dateStr),
                    diet: (targetPlan.dietEntries || []).some(e => e.date === dateStr)
                };
            };

            // --- Ë®àÁÆóÂ±¨ÊÄß ---
            const activePlan = useMemo(() => plans.find(p => p.id === activePlanId) || null, [plans, activePlanId]);
            const isNoPlans = useMemo(() => plans.length === 0, [plans]);
            
            const daysLeft = useMemo(() => {
                if (!activePlan || !activePlan.targetDate) return 0;
                const target = new Date(activePlan.targetDate);
                const today = new Date();
                today.setHours(0,0,0,0); target.setHours(0,0,0,0);
                return Math.max(0, Math.ceil((target.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)));
            }, [activePlan]);

            const latestWeight = useMemo(() => activePlan?.workoutEntries?.find(e => e.weight > 0)?.weight || activePlan?.baselineWeight || 57, [activePlan]);

            const weekDaysList = useMemo(() => {
                const now = new Date();
                const start = new Date(now);
                start.setDate(now.getDate() - now.getDay() + (weekOffset * 7));
                return Array.from({ length: 7 }, (_, i) => {
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    return { date: d.toISOString().split('T')[0], label: ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][i], num: d.getDate() };
                });
            }, [weekOffset, plans, activePlanId]);

            const currentMonthLabel = useMemo(() => {
                if (weekDaysList.length === 0) return "";
                const d = new Date(weekDaysList[0].date);
                return `${d.getMonth() + 1}Êúà Êú¨ÈÄ±`;
            }, [weekDaysList]);

            const groupedRecords = useMemo(() => {
                if (!activePlan) return [];
                const entries = view === 'history' ? (activePlan.workoutEntries || []) : (activePlan.dietEntries || []);
                const groups = entries.reduce((acc, entry) => {
                    if (!acc[entry.date]) acc[entry.date] = [];
                    acc[entry.date].push(entry);
                    return acc;
                }, {});
                return Object.keys(groups).sort((a, b) => new Date(b) - new Date(a)).map(date => ({
                    date,
                    items: groups[date].sort((a, b) => (b.time || '').localeCompare(a.time || ''))
                }));
            }, [activePlan, view]);

            const nutrientInsight = useMemo(() => {
                const t = getDayDietTotals(historyFilterDate);
                if (t.kcal === 0) return "‰ªäÂ§©ÈÇÑÊ≤íÊúâÁ¥ÄÈåÑÈ£≤È£üÂñî ‚ú®";
                return t.p > 60 ? "ËõãÁôΩË≥™ÂÖÖË∂≥ÔºÅËÇåËÇâÊ≠£Âú®ÊÑüË¨ùÂ¶≥ÔºÅüí™" : "ÊØî‰æã‰∏çÈåØÂñîÔºÅÁπºÁ∫åÊúùÁõÆÊ®ôÈÇÅÈÄ≤ÔºÅüåü";
            }, [activePlan, historyFilterDate]);

            const todayReinforcement = useMemo(() => DAILY_REINFORCEMENTS[new Date(historyFilterDate).getDate() % DAILY_REINFORCEMENTS.length || 0], [historyFilterDate]);

            // --- Ê∏≤ÊüìÂç°ÁâáËºîÂä© ---
            const renderDietCard = (entry) => {
                const totalMacros = (entry.p || 0) + (entry.f || 0) + (entry.c || 0) || 1;
                return (
                    <div key={entry.id} className="premium-card p-4 margin-consistency text-[#040316]">
                        <div className="flex justify-between items-center mb-3">
                            <span className="text-[12px] font-bold text-[#9caeba] flex items-center gap-1.5"><Icon name="clock" size={12}/>{entry.time}</span>
                            <div className="flex items-center -mr-2">
                                <button onClick={()=>handleEditRecord(entry, 'diet')} className="touch-target text-[#9caeba] active:text-[#f9991a] transition-all"><Icon name="edit-3" size={24}/></button>
                                <button onClick={()=>confirmDelete('diet', entry.id)} className="touch-target text-[#9caeba] active:text-red-400 transition-all"><Icon name="trash-2" size={24}/></button>
                            </div>
                        </div>
                        <div className="space-y-4">
                            <div className="flex flex-wrap gap-2">
                                {['breakfast', 'lunch', 'dinner', 'snacks'].map(meal => entry[meal] && (
                                    <div key={meal} className="flex items-center gap-1.5 bg-gray-50 px-3 py-1.5 rounded-xl border border-gray-100/50">
                                        <Icon name={meal==='breakfast'?'sun':meal==='lunch'?'sun-medium':meal==='dinner'?'moon':'coffee'} size={14} className="text-[#9caeba]"/>
                                        <span className="text-[14px] font-bold leading-none">{entry[meal]}</span>
                                    </div>
                                ))}
                            </div>
                            <div className="pt-2 border-t border-dashed border-gray-200 flex items-center justify-between text-[12px] font-bold text-[#5a6a7a]">
                                <div className="flex gap-3"><span className="text-[#f9991a]">P {entry.p}g</span><span className="text-[#9caeba]">F {entry.f}g</span><span>C {entry.c}g</span></div>
                                <div className="flex items-center gap-1.5 text-blue-400"><Icon name="droplets" size={12}/>{entry.water}cc</div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="nutrient-bar-bg flex-1">
                                    <div className="bar-p" style={{ width: `${((entry.p||0)/totalMacros)*100}%` }}></div>
                                    <div className="bar-f" style={{ width: `${((entry.f||0)/totalMacros)*100}%` }}></div>
                                    <div className="bar-c" style={{ width: `${((entry.c||0)/totalMacros)*100}%` }}></div>
                                </div>
                                <div className="text-[15px] font-bold whitespace-nowrap">{entry.kcal} <span className="text-[10px] text-[#9caeba] uppercase tracking-tighter">kcal</span></div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderWorkoutCard = (entry) => (
                <div key={entry.id} className="premium-card p-4 margin-consistency text-[#040316]">
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-[12px] font-bold text-[#9caeba] flex items-center gap-1.5"><Icon name="clock" size={12}/>{entry.time}</span>
                        <div className="flex items-center -mr-2">
                            <button onClick={()=>handleEditRecord(entry, 'workout')} className="touch-target text-[#9caeba] active:text-[#f9991a] transition-all"><Icon name="edit-3" size={24}/></button>
                            <button onClick={()=>confirmDelete('workout', entry.id)} className="touch-target text-[#9caeba] active:text-red-400 transition-all"><Icon name="trash-2" size={24}/></button>
                        </div>
                    </div>
                    <div className="space-y-3">
                        <div className="space-y-2.5">
                            {entry.exercises?.map((ex, idx) => (
                                <div key={idx} className="flex justify-between items-center py-2.5 px-3 bg-orange-50/50 rounded-xl border border-orange-100/30">
                                    <span className="text-[14px] font-bold">{ex.name}</span>
                                    <span className="text-[12px] font-bold text-[#f9991a] bg-white px-2 py-0.5 rounded-lg border border-orange-100 uppercase tracking-tight">{ex.sets}ÁµÑ / {ex.reps}Ê¨°</span>
                                </div>
                            ))}
                        </div>
                        <div className="flex flex-wrap gap-1.5 pt-1">{entry.parts?.map(p => <span key={p} className="text-[11px] font-bold bg-[#f2f4f7] text-[#9caeba] px-2.5 py-1 rounded-full uppercase tracking-widest">{p}</span>)}</div>
                        {entry.note && <p className="text-[13px] text-[#5a6a7a] italic mt-2 border-l-4 border-orange-100/50 pl-3 leading-relaxed bg-orange-50/20 py-2 rounded-r-lg">{entry.note}</p>}
                    </div>
                </div>
            );

            // --- ÈÇèËºØÂáΩÊï∏ ---
            const closeModal = () => { 
                setShowEntryModal(false); setShowPlanModal(false); setEditingPlanId(null); setEditingId(null);
                setWNote(''); setWExercises([]); setWParts([]); setDietForm({ breakfast: '', lunch: '', dinner: '', snacks: '' });
                setDWater(200); setIsSaving(false);
            };

            const handleHeaderPlusClick = () => {
                if (view === 'plan' || !activePlan) {
                    setEditingPlanId(null); setNewPlanTitle(''); setNewPlanDate('');
                    setShowPlanModal(true);
                } else {
                    setEditingId(null); setEntryType(view === 'diet' ? 'diet' : 'workout');
                    setShowEntryModal(true);
                }
            };

            const handleEditPlan = (plan) => {
                setEditingPlanId(plan.id); setNewPlanTitle(plan.title); setNewPlanDate(plan.targetDate);
                setNewPlanBaselineWeight(plan.baselineWeight.toString()); setNewPlanTargetWeight(plan.targetWeight.toString());
                setShowPlanModal(true);
            };

            const handleEditRecord = (entry, type) => {
                setEntryType(type); setEditingId(entry.id);
                if (type === 'workout') { setWDate(entry.date); setWParts(entry.parts || []); setWExercises(entry.exercises || []); setWNote(entry.note || ''); }
                else { setDDate(entry.date); setDietForm({ breakfast: entry.breakfast, lunch: entry.lunch, dinner: entry.dinner, snacks: entry.snacks }); setDWater(entry.water); }
                setShowEntryModal(true);
            };

            const confirmDelete = (type, id, extra = null) => {
                setConfirmAction({ type, id, extra });
                setShowConfirmModal(true);
            };

            const executeDelete = () => {
                if (!confirmAction) return;
                const { type, id, extra } = confirmAction;
                if (type === 'plan') {
                    setPlans(plans.filter(p => p.id !== id));
                    if (activePlanId === id) setActivePlanId(null);
                } else if (type === 'workout' && activePlan) {
                    setPlans(plans.map(p => p.id === activePlan.id ? { ...p, workoutEntries: p.workoutEntries.filter(e => e.id !== id) } : p));
                } else if (type === 'diet' && activePlan) {
                    setPlans(plans.map(p => p.id === activePlan.id ? { ...p, dietEntries: p.dietEntries.filter(e => e.id !== id) } : p));
                } else if (type === 'quickFood') {
                    setQuickFoods(prev => ({ ...prev, [extra]: prev[extra].filter(f => f !== id) }));
                }
                setShowConfirmModal(false);
            };

            const handleQuickFoodSelect = (meal, food) => {
                setDietForm(p => ({ ...p, [meal]: p[meal] ? p[meal] + "„ÄÅ" + food : food }));
            };

            const handleSaveEntry = async () => {
                if (!activePlan) return;
                setIsSaving(true);
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                let updatedPlan = { ...activePlan };
                if (editingId) {
                    if (entryType === 'workout') {
                        const newE = { id: editingId, date: w_date, time, parts: w_parts, note: w_note, exercises: w_exercises, weight: latestWeight };
                        updatedPlan.workoutEntries = (updatedPlan.workoutEntries || []).map(e => e.id === editingId ? newE : e);
                    } else {
                        const fullText = Object.values(dietForm).filter(v => !!v).join('Ôºå');
                        const data = await fetchBatchNutritionData(fullText);
                        const newE = { id: editingId, date: d_date, time, ...dietForm, water: Number(d_water), kcal: data.kcal, p: data.p, f: data.f, c: data.c };
                        updatedPlan.dietEntries = (updatedPlan.dietEntries || []).map(e => e.id === editingId ? newE : e);
                    }
                } else {
                    const hasWorkoutData = w_exercises.length > 0 || w_note.trim() !== "";
                    const hasDietData = Object.values(dietForm).some(v => v.trim() !== "") || d_water > 0;
                    if (hasWorkoutData) {
                        const newW = { id: Date.now(), date: w_date, time, parts: w_parts, note: w_note, exercises: w_exercises, weight: latestWeight };
                        updatedPlan.workoutEntries = [newW, ...(updatedPlan.workoutEntries || [])];
                    }
                    if (hasDietData) {
                        const fullText = Object.values(dietForm).filter(v => !!v).join('Ôºå');
                        const data = await fetchBatchNutritionData(fullText);
                        const newD = { id: Date.now() + 1, date: d_date, time, ...dietForm, water: Number(d_water), kcal: data.kcal, p: data.p, f: data.f, c: data.c };
                        updatedPlan.dietEntries = [newD, ...(updatedPlan.dietEntries || [])];
                    }
                }
                setPlans(plans.map(p => p.id === activePlan.id ? updatedPlan : p));
                closeModal();
            };

            const handleCreatePlan = () => {
                if (!newPlanTitle || !newPlanDate) return;
                const id = editingPlanId || `p-${Date.now()}`;
                const p = editingPlanId 
                  ? { ...plans.find(x => x.id === id), title: newPlanTitle, targetDate: newPlanDate, baselineWeight: parseFloat(newPlanBaselineWeight), targetWeight: parseFloat(newPlanTargetWeight) }
                  : { id, title: newPlanTitle, targetDate: newPlanDate, baselineWeight: parseFloat(newPlanBaselineWeight), targetWeight: parseFloat(newPlanTargetWeight), workoutEntries: [], dietEntries: [] };
                if (editingPlanId) setPlans(plans.map(x => x.id === id ? p : x)); else { setPlans([p, ...plans]); setActivePlanId(id); }
                closeModal(); setView('home');
            };

            const handleSaveWeight = (val) => {
                const w = parseFloat(val); if (isNaN(w) || w <= 0) return;
                setConfirmAnim(true);
                setPlans(plans.map(p => p.id === activePlan.id ? { ...p, workoutEntries: [{ id: Date.now(), date: new Date().toISOString().split('T')[0], weight: w, note: '‰ªäÊó•Á®±Èáç' }, ...(p.workoutEntries || [])] } : p));
                setTimeout(() => { setConfirmAnim(false); setIsEditingWeight(false); }, 800);
            };

            const handleAddExercise = (name) => setWExercises(p => p.some(e => e.name === name) ? p.filter(e => e.name !== name) : [...p, { name, sets: 3, reps: 12 }]);
            const updateEx = (name, field, delta) => setWExercises(p => p.map(ex => ex.name === name ? { ...ex, [field]: Math.max(1, ex[field] + delta) } : ex));

            return (
                <div id="root">
                    <header className={`z-30 transition-all ${view === 'home' ? 'p-4' : 'sticky top-0 bg-white/60 backdrop-blur-xl border-b border-gray-100/50 px-4 h-[64px] flex items-center'}`}>
                        {view === 'home' ? (
                            <div className="space-y-4 w-full">
                                <div className="flex justify-between items-center text-[#5a6a7a]">
                                    <div className="flex items-center gap-3">
                                        <div className="w-14 h-14 rounded-full border-2 border-white shadow-md overflow-hidden bg-white"><img src="https://raw.githubusercontent.com/Minpi-0/Health-Tracker/main/img/avatar-myself.svg" alt="avatar" /></div>
                                        <div className="flex flex-col"><h2 className="text-[20px] font-bold leading-tight">Hello Min!</h2><div className="text-[14px] font-medium text-[#94a3b8] flex items-center">ÁõÆÂâç <span className="text-[#f9991a] mx-1 font-bold">{latestWeight}</span><span className="mx-1 opacity-30">|</span> ÂàùÂßã {activePlan?.baselineWeight || latestWeight}</div></div>
                                    </div>
                                    <div className="flex gap-2.5">
                                        <div className="status-circle bg-white text-[#f9991a] font-bold">{activePlan?.targetWeight || '0'}</div>
                                        <div className="status-circle bg-[#f9991a] text-white font-bold">-{daysLeft}</div>
                                    </div>
                                </div>
                                <div className="bg-white/30 backdrop-blur-md border border-white/20 rounded-[16px] p-4 shadow-sm">
                                    <div className="flex justify-between items-center mb-3 text-[11px] font-bold uppercase tracking-wider">
                                        <span className="text-[14px] text-[#f9991a] font-bold">{currentMonthLabel}</span>
                                        <div className="flex gap-4"><div onClick={()=>setWeekOffset(v=>v-1)} className="cursor-pointer active:scale-90"><Icon name="chevron-left" size={16}/></div><div onClick={()=>setWeekOffset(v=>v+1)} className="cursor-pointer active:scale-90"><Icon name="chevron-right" size={16}/></div></div>
                                    </div>
                                    <div className="flex justify-between items-center px-1">
                                        {weekDaysList.map(day => {
                                            const { workout, diet } = dateStats(day.date);
                                            const isSelected = historyFilterDate === day.date;
                                            return (
                                                <div key={day.date} className="flex flex-col items-center gap-1.5 cursor-pointer" onClick={() => setHistoryFilterDate(day.date)}>
                                                    <span className="text-[10px] font-bold text-[#9caeba]">{day.label}</span>
                                                    <div className={`w-[42px] h-[42px] rounded-xl flex items-center justify-center font-bold text-[14px] transition-all ${isSelected ? 'border-2 border-[#f9991a] text-[#f9991a] bg-white shadow-sm' : (workout||diet)?'bg-[#f9991a] text-white':'bg-gray-100/50 text-[#9caeba]'}`}>{day.num}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex items-center justify-between relative h-full">
                                <div className="w-10"></div>
                                <h1 className="absolute left-1/2 -translate-x-1/2 text-[18px] font-bold text-[#5a6a7a] whitespace-nowrap">{view==='plan'?'Ë®àÁï´ÁÆ°ÁêÜ':view==='history'?'ÈÅãÂãïÂõûÈ°ß':'È£≤È£üÁµ±Ë®à'}</h1>
                                <button onClick={handleHeaderPlusClick} className="header-plus-circle relative z-10"><Icon name="plus" size={24} /></button>
                            </div>
                        )}
                    </header>

                    <main className="flex-1 overflow-y-auto px-4 pt-4 no-scrollbar pb-[120px]">
                        {view === 'home' ? (
                            activePlan ? (
                                <>
                                    <section className="premium-card p-4 flex items-center justify-between text-[#040316] margin-consistency">
                                        <p className="text-[16px] font-bold text-[#7a8b9a]">Êó©Êô®ÁöÑÊàë</p>
                                        <div className={`flex-1 mx-4 bg-[#f2f7ff] rounded-[16px] h-10 flex items-center justify-center transition-all ${confirmAnim ? 'scale-105 bg-orange-50 shadow-inner' : ''}`}>
                                            {isEditingWeight ? <input autoFocus type="number" step="0.1" value={w_weight} onChange={e=>setWWeight(e.target.value)} onBlur={()=>handleSaveWeight(w_weight)} className="bg-transparent w-full text-center text-[18px] font-bold outline-none" /> : <p className="text-[18px] font-bold">{latestWeight}<span className="text-[14px] font-bold text-[#9caeba] ml-1">kg</span></p>}
                                        </div>
                                        {!isEditingWeight && <div onClick={()=>setIsEditingWeight(true)} className="cursor-pointer p-1 text-[#9caeba]"><Icon name="edit-3" size={18} /></div>}
                                    </section>
                                    <section className="premium-card p-5 shadow-sm relative overflow-hidden margin-consistency" style={{ backgroundImage: `url('https://raw.githubusercontent.com/Minpi-0/Health-Tracker/main/img/bg-mission.svg')`, backgroundSize: 'cover', backgroundPosition: 'center', border: 'none' }}>
                                        <div className="relative z-10 flex flex-col gap-3 text-[#040316]">
                                            <p className="text-[13px] font-bold text-[#5a6a7a]">‰ªäÊó•ÊåëÊà∞ÔºÅ</p>
                                            <div className="flex items-center gap-3"><h2 className="text-[24px] font-bold text-[#f9991a] leading-none">{todayReinforcement.name}</h2><span className="px-3 py-1 bg-[#fff7ed] text-[#f9991a] text-[12px] font-bold rounded-lg border border-orange-100">12x3ÁµÑ</span></div>
                                            <p className="text-[14px] text-[#5a6a7a] leading-relaxed font-medium">{todayReinforcement.explanation}</p>
                                            <div className="flex gap-3 pt-2">
                                                <button onClick={()=>window.open(`https://www.youtube.com/results?search_query=${todayReinforcement.name}`, '_blank')} className="flex-1 h-11 border-2 border-[#f9991a] text-[#f9991a] bg-white/80 rounded-full font-bold text-[14px] active:scale-95 transition-all">Â≠∏Âãï‰Ωú</button>
                                                <button onClick={()=>{setEntryType('workout'); setEditingId(null); setWNote(`Ë£úÂº∑Ôºö${todayReinforcement.name}`); setShowEntryModal(true);}} className="flex-1 h-11 bg-[#f9991a] text-white rounded-full font-bold text-[14px] shadow-lg active:scale-95 transition-all">ÊâìÂç°</button>
                                            </div>
                                        </div>
                                    </section>
                                    <div className="grid grid-cols-2 gap-4 margin-consistency">
                                        <button onClick={()=>setView('history')} className="premium-card p-5 flex flex-col items-center gap-3 active:scale-95 shadow-sm">
                                            <Icon name="dumbbell" size={26} className="text-[#f9991a]"/>
                                            <p className="text-[16px] font-bold text-[#7a8b9a]">Ë®ìÁ∑¥Êó•Ë™å</p>
                                        </button>
                                        <button onClick={()=>setView('diet')} className="premium-card p-5 flex flex-col items-center gap-3 active:scale-95 shadow-sm">
                                            <Icon name="utensils" size={26} className="text-[#5a6a7a]"/>
                                            <p className="text-[16px] font-bold text-[#7a8b9a]">È£≤È£üÁ¥ÄÈåÑ</p>
                                        </button>
                                    </div>
                                </>
                            ) : (
                                <div className="flex-1 flex flex-col items-center justify-center min-h-[460px] relative overflow-hidden bg-transparent">
                                    <div className="flex flex-col items-center gap-8 relative z-20 text-[#040316]"><h2 className="text-[16px] font-bold text-[#334155] tracking-wide text-center">ÊâìÈÄ†Â¶≥ÁöÑÂ∞àÂ±¨Ë®àÁï´</h2><button onClick={handleHeaderPlusClick} className="primary-btn px-20 shadow-xl text-white active:scale-95 transition-all">Á´ãÂç≥Êñ∞Â¢û</button></div>
                                    <div className="absolute bottom-0 left-0 right-0 h-[220px] pointer-events-none mb-[-50px] z-10 flex items-center justify-center"><lottie-player src="https://raw.githubusercontent.com/Minpi-0/Health-Tracker/main/img/Sunrise%20-%20Breathe%20in%20Breathe%20out.json" background="transparent" speed="1" loop autoplay style={{ width: '100%', height: '100%' }}></lottie-player></div>
                                </div>
                            )
                        ) : (view === 'history' || view === 'diet') ? (
                            <div className="space-y-0 text-brand">
                                <div className="premium-card p-5 bg-white shadow-md text-[#040316] space-y-4 margin-consistency">
                                    <div className="flex justify-between items-center text-brand">
                                        <span className="text-[12px] font-bold text-[#9caeba] uppercase tracking-widest">{view === 'history' ? 'Ë®ìÁ∑¥ÊëòË¶Å' : 'ÁáüÈ§äÊëòË¶Å'}</span>
                                        <span className="text-[14px] font-bold text-blue-400 flex items-center gap-1"><Icon name={view === 'history'?'dumbbell':'droplets'} size={14}/>{view === 'history' ? `${getDayWorkoutTotals(historyFilterDate)} Á≠Ü` : `${getDayDietTotals(historyFilterDate).water} cc`}</span>
                                    </div>
                                    
                                    {/* Êô∫ÊÖßÊëòË¶ÅÁ∂≤Ê†ºÔºöÊîπÁÇ∫ÁπÅÈ´î‰∏≠ÊñáÊ®ôÁ±§ */}
                                    {view === 'history' ? (
                                        <div className="grid grid-cols-3 gap-2">
                                            <div className="bg-orange-50/50 rounded-xl p-3 flex flex-col items-center border border-orange-100/50 text-brand"><span className="text-[10px] font-bold text-[#f9991a] uppercase mb-1 text-center">Á¥ÄÈåÑ</span><span className="text-[15px] font-bold">{getDayWorkoutTotals(historyFilterDate)} Á≠Ü</span></div>
                                            <div className="bg-gray-50 rounded-xl p-3 flex flex-col items-center border border-gray-100 text-brand"><span className="text-[10px] font-bold text-[#9caeba] uppercase mb-1 text-center">ÁãÄÊÖã</span><span className="text-[15px] font-bold">ËâØÂ•Ω</span></div>
                                            <div className="bg-blue-50/50 rounded-xl p-3 flex flex-col items-center border border-blue-100 text-brand"><span className="text-[10px] font-bold text-[#5a6a7a] uppercase mb-1 text-center text-brand">ÈÄ≤Â∫¶</span><span className="text-[15px] font-bold">Á©©ÂÆö</span></div>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-4 gap-1.5">
                                            <div className="bg-orange-50/50 rounded-xl p-2.5 flex flex-col items-center border border-orange-100/50 text-brand"><span className="text-[10px] font-bold text-[#f9991a] mb-1">ÁÜ±Èáè</span><span className="text-[14px] font-bold">{getDayDietTotals(historyFilterDate).kcal}</span></div>
                                            <div className="bg-blue-50/50 rounded-xl p-2.5 flex flex-col items-center border border-blue-100 text-brand"><span className="text-[10px] font-bold text-[#5a6a7a] mb-1">ËõãÁôΩ</span><span className="text-[14px] font-bold">{getDayDietTotals(historyFilterDate).p}g</span></div>
                                            <div className="bg-gray-50 rounded-xl p-2.5 flex flex-col items-center border border-gray-100 text-brand"><span className="text-[10px] font-bold text-[#9caeba] mb-1">ËÑÇËÇ™</span><span className="text-[14px] font-bold">{getDayDietTotals(historyFilterDate).f}g</span></div>
                                            <div className="bg-gray-50 rounded-xl p-2.5 flex flex-col items-center border border-gray-100 text-brand"><span className="text-[10px] font-bold text-[#9caeba] mb-1">Á¢≥Ê∞¥</span><span className="text-[14px] font-bold">{getDayDietTotals(historyFilterDate).c}g</span></div>
                                        </div>
                                    )}

                                    <div className="bg-[#f2f4f7] p-3 rounded-xl text-brand"><p className="text-[12px] italic font-medium text-[#5a6a7a]">„Äå{nutrientInsight}„Äç</p></div>
                                </div>
                                {groupedRecords.length > 0 ? groupedRecords.map(group => (
                                    <div key={group.date}>
                                        <div className="timeline-date-chip margin-consistency">{group.date === new Date().toISOString().split('T')[0] ? '‰ªäÂ§©' : group.date}</div>
                                        {group.items.map(item => view === 'history' ? renderWorkoutCard(item) : renderDietCard(item))}
                                    </div>
                                )) : <div className="py-20 text-center opacity-40 text-[#9caeba]"><Icon name="calendar-range" size={48}/><p className="font-bold text-[14px]">ÁõÆÂâçÂ∞öÁÑ°Á¥ÄÈåÑÊï∏Êìö</p></div>}
                            </div>
                        ) : view === 'plan' ? (
                            <div className="space-y-0 text-brand">
                                {plans.map(p => (
                                    <div key={p.id} className={`premium-card p-5 transition-all text-[#040316] margin-consistency shadow-sm border-transparent`}>
                                        <div className="flex justify-between items-start mb-4 text-brand">
                                            <div className="flex flex-col gap-1">
                                                <h3 className="text-[18px] font-bold tracking-tight">{p.title}</h3>
                                                <div className="flex items-center gap-2 text-[14px] font-bold text-[#9caeba]"><Icon name="calendar" size={12} /> {p.targetDate} Êà™Ê≠¢</div>
                                            </div>
                                            <div className="flex gap-1 -mr-2">
                                                <button onClick={()=>handleEditPlan(p)} className="touch-target text-[#9caeba] active:text-[#f9991a] transition-all"><Icon name="edit-3" size={24}/></button>
                                                <button onClick={()=>confirmDelete('plan', p.id)} className="touch-target text-[#9caeba] active:text-red-400 transition-all"><Icon name="trash-2" size={24}/></button>
                                            </div>
                                        </div>
                                        <div className="bg-blue-50/50 rounded-[12px] p-4 mb-4 flex items-center justify-between border border-white/40 text-[14px] text-brand">
                                            <div className="flex flex-col items-center flex-1 text-brand"><span className="text-[14px] font-bold text-[#9caeba] uppercase mb-1">Ëµ∑Âßã</span><span className="font-bold text-[#5a6a7a]">{p.baselineWeight} kg</span></div>
                                            <Icon name="chevron-right" size={16} className="text-[#9caeba] opacity-30 mx-2 text-brand" />
                                            <div className="flex flex-col items-center flex-1 text-brand"><span className="text-[14px] font-bold text-[#f9991a] uppercase mb-1">ÁõÆÊ®ô</span><span className="font-bold text-[#f9991a]">{p.targetWeight} kg</span></div>
                                        </div>
                                        {activePlanId!==p.id ? <button onClick={()=>{setActivePlanId(p.id);setView('home');}} className="primary-btn w-full shadow-sm text-white font-bold tracking-widest uppercase">ÂïüÂãïË®àÁï´</button> : <div className="flex items-center justify-center gap-2 text-[#f9991a] font-bold text-[14px] py-2 bg-orange-50 rounded-[12px]"><Icon name="check-circle" size={16} /> ÁõÆÂâçÂü∑Ë°å‰∏≠</div>}
                                    </div>
                                ))}
                            </div>
                        ) : null}
                    </main>

                    <nav className="island-navbar text-[#9caeba] text-brand">
                        <div className="flex flex-1 justify-around items-center">
                            <button onClick={()=>setView('home')} className={`flex flex-col items-center gap-0.5 transition-all ${view==='home'?'text-[#f9991a] scale-105':'opacity-60'}`}><Icon name="home" size={24} /><span className="text-[12px] font-bold tracking-tight">È¶ñÈ†Å</span></button>
                            <button onClick={()=>setView('history')} className={`flex flex-col items-center gap-0.5 transition-all ${view==='history'?'text-[#f9991a] scale-105':'opacity-60'}`}><Icon name="activity" size={24} /><span className="text-[12px] font-bold tracking-tight text-brand">ÈÅãÂãï</span></button>
                        </div>
                        {/* Êô∫ÊÖß‰∏ªÊåâÈàï */}
                        <button onClick={handleHeaderPlusClick} className="glow-action-btn shadow-xl active:scale-90 text-white font-bold tracking-widest text-[16px]">
                            {(!activePlan) ? "GO!" : <Icon name="plus" size={32} className="text-white" />}
                        </button>
                        <div className="flex flex-1 justify-around items-center">
                            <button onClick={()=>setView('diet')} className={`flex flex-col items-center gap-0.5 transition-all ${view==='diet'?'text-[#f9991a] scale-105':'opacity-60'}`}><Icon name="utensils" size={24} /><span className="text-[12px] font-bold tracking-tight">È£≤È£ü</span></button>
                            <button onClick={()=>setView('plan')} className={`flex flex-col items-center gap-0.5 transition-all ${view==='plan'?'text-[#f9991a] scale-105':'opacity-60'}`}><Icon name="clipboard" size={24} /><span className="text-[12px] font-bold tracking-tight text-brand">Ë®àÁï´</span></button>
                        </div>
                    </nav>

                    {/* --- ÈåÑÂÖ•ÂΩàÁ™ó --- */}
                    {showEntryModal && (
                        <div className="sheet-container text-[#040316]">
                            <div className="sheet-backdrop" onClick={closeModal} />
                            <div className="sheet-content">
                                <header className="h-[64px] px-4 flex justify-between items-center border-b border-gray-50 bg-white sticky top-0 z-20 text-brand">
                                    <div className="w-10 text-brand"></div>
                                    <h3 className="text-[18px] font-bold text-[#5a6a7a]">{editingId?'Á∑®ËºØÁ¥ÄÈåÑ':'Êñ∞Â¢ûÁ¥ÄÈåÑ'}</h3>
                                    <div onClick={closeModal} className="touch-target text-[#9caeba] text-brand text-brand"><Icon name="x" size={24} /></div>
                                </header>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-4 text-brand">
                                    {!editingId && (
                                        <div className="flex bg-gray-100 p-1 rounded-xl text-brand text-brand">
                                            <button onClick={()=>setEntryType('workout')} className={`flex-1 h-[32px] rounded-[10px] text-[13px] font-bold transition-all ${entryType==='workout'?'bg-white shadow-sm text-[#040316]':'text-[#9caeba]'}`}>Ë®ìÁ∑¥È†ÖÁõÆ</button>
                                            <button onClick={()=>setEntryType('diet')} className={`flex-1 h-[32px] rounded-[10px] text-[13px] font-bold transition-all ${entryType==='diet'?'bg-white shadow-sm text-[#040316]':'text-[#9caeba]'}`}>È£≤È£üÈ§êÈªû</button>
                                        </div>
                                    )}
                                    {!editingId && (
                                        <div className="bg-blue-50/80 p-4 rounded-xl text-blue-600 text-[14px] flex items-center gap-3 border border-blue-200 shadow-sm text-brand text-brand">
                                            <Icon name="info" size={18} className="text-blue-500" />
                                            <span>Â¶≥ÂèØ‰ª•ÂêåÊôÇÂ°´ÂØ´ÂàÜÈ†ÅÂÖßÂÆπÔºåÊåâ‰∏ãÂÑ≤Â≠òÂ∞á‰∏Ä‰ΩµÈåÑÂÖ•ÔºÅ</span>
                                        </div>
                                    )}
                                    <div className="space-y-4 text-brand">
                                        <div><span className="text-[16px] font-bold text-[#5a6a7a] mb-2 block text-brand">Á¥ÄÈåÑÊó•Êúü</span><input type="date" value={entryType==='workout'?w_date:d_date} onChange={e=>entryType==='workout'?setWDate(e.target.value):setDDate(e.target.value)} className="px-[12px] h-11 bg-blue-50/50 rounded-xl w-full border-none outline-none text-brand text-brand" /></div>
                                        {entryType === 'workout' ? (
                                            <div className="space-y-4 text-brand text-brand">
                                                <div><span className="text-[16px] font-bold text-[#5a6a7a] mb-2 block text-brand text-brand">Ë®ìÁ∑¥ÈÉ®‰Ωç</span><div className="flex gap-2 flex-wrap text-brand">{BODY_PARTS.map(p => (<button key={p} onClick={()=>setWParts(v => v.includes(p) ? v.filter(i=>i!==p) : [...v, p])} className={`tag-btn ${w_parts.includes(p)?'active':''}`}>{p}</button>))}</div></div>
                                                <div>
                                                    <span className="text-[16px] font-bold text-[#5a6a7a] mb-2 block text-brand text-brand">Âãï‰ΩúÊ∏ÖÂñÆ</span>
                                                    <div className="flex gap-2 overflow-x-auto no-scrollbar mb-3 text-brand text-brand">{Object.keys(PILATES_DATABASE).map(cat => (<button key={cat} onClick={()=> setWCategory(cat)} className={`tag-btn ${w_category===cat?'active':''}`}>{cat.split(' ')[0]}</button>))}</div>
                                                    <div className="equipment-block text-brand text-brand text-brand"><div className="space-y-2 text-brand text-brand">
                                                            {PILATES_DATABASE[w_category].map(move => { const cE = w_exercises.find(e => e.name === move); const isS = !!cE; return (<div key={move} className={`exercise-item-card ${isS?'active':''}`}><div className="flex items-center justify-between w-full text-brand text-brand text-brand"><div className="flex items-center gap-4 flex-1 cursor-pointer text-brand text-brand text-brand" onClick={() => handleAddExercise(move)}><div className={`plus-box ${isS?'active':''}`}><Icon name={isS ? "check" : "plus"} size={18} /></div><span className="text-[14px] font-bold text-brand">{move}</span></div><button onClick={(e) => { e.stopPropagation(); watchYoutube(move); }} className="touch-target text-red-300 active:scale-90 text-brand text-brand"><Icon name="youtube" size={20} /></button></div>{isS && (<div className="flex gap-4 pt-1 border-t border-orange-50 text-[12px] font-bold text-[#5a6a7a] text-brand text-brand text-brand"><div className="flex-1 flex items-center bg-[#f2f4f7] rounded-xl px-2 py-1.5 text-brand text-brand"><button onClick={()=>updateEx(move, 'sets', -1)} className="stepper-btn text-brand text-brand">-</button><span className="flex-1 text-center text-brand text-brand">{cE.sets}ÁµÑ</span><button onClick={()=>updateEx(move, 'sets', 1)} className="stepper-btn text-brand text-brand text-brand">+</button></div><div className="flex-1 flex items-center bg-[#f2f4f7] rounded-xl px-2 py-1.5 text-brand text-brand text-brand"><button onClick={()=>updateEx(move, 'reps', -1)} className="stepper-btn text-brand text-brand">-</button><span className="flex-1 text-center text-brand text-brand">{cE.reps}Ê¨°</span><button onClick={()=>updateEx(move, 'reps', 1)} className="stepper-btn text-brand text-brand text-brand">+</button></div></div>)}</div>); })}
                                                    </div></div>
                                                </div>
                                                <div><span className="text-[16px] font-bold text-[#5a6a7a] mb-2 block text-brand text-brand">Ë®ìÁ∑¥Èö®Á≠Ü</span><textarea value={w_note} onChange={e=>setWNote(e.target.value)} placeholder="Â¶≥‰ªäÂ§©ÁöÑÂøÉÊÉÖÂ¶Ç‰ΩïÔºü" className="note-textarea bg-blue-50/50 text-brand" /></div>
                                            </div>
                                        ) : (
                                            <div className="space-y-4 text-brand text-brand">
                                                <div className="flex items-center justify-between bg-blue-50/50 p-6 rounded-[24px] text-[#f9991a] shadow-inner text-brand text-brand text-brand"><div className="flex items-center gap-4 text-brand text-brand text-brand text-brand text-brand"><Icon name="droplets" size={26} /><div className="flex items-baseline min-w-[110px] text-[#040316] text-brand text-brand text-brand text-brand text-brand"><input type="number" value={d_water} onChange={e=>setDWater(e.target.value)} className="w-24 bg-transparent text-[28px] font-bold outline-none" /><span className="text-[14px] font-bold text-[#9caeba] ml-1 text-brand text-brand">cc</span></div></div><div className="flex gap-2 text-brand text-brand text-brand text-brand"><button onClick={()=>setDWater(Math.max(0,Number(d_water)-250))} className="w-10 h-10 bg-white rounded-xl shadow-sm font-bold active:scale-90 text-[#040316] text-brand">-</button><button onClick={()=>setDWater(Number(d_water)+250)} className="w-10 h-10 bg-[#f9991a] text-white rounded-xl shadow-md active:scale-90 text-brand text-brand">+</button></div></div>
                                                {['breakfast', 'lunch', 'dinner', 'snacks'].map(meal => (
                                                    <div key={meal} className="space-y-2 text-brand text-brand text-brand">
                                                        <p className="text-[16px] font-bold text-[#5a6a7a] mb-2 text-brand text-brand text-brand">{meal==='breakfast'?'Êó©È§ê':meal==='lunch'?'ÂçàÈ§ê':meal==='dinner'?'ÊôöÈ§ê':'ÈªûÂøÉ'}</p>
                                                        <textarea value={dietForm[meal]} onChange={e=>setDietForm(p => ({ ...p, [meal]: e.target.value }))} rows="2" placeholder="Á¥ÄÈåÑÈ§êÈªûÂÖßÂÆπ..." className="text-[14px] p-3 bg-blue-50/50 rounded-xl w-full border-none outline-none text-[#040316] text-brand text-brand text-brand text-brand" />
                                                        <div className="flex gap-2 overflow-x-auto no-scrollbar pt-1 items-center text-brand text-brand text-brand text-brand">
                                                            {quickFoods[meal]?.map(f => (
                                                                <div key={f} className="relative group text-brand text-brand text-brand text-brand text-brand">
                                                                    <button onClick={() => handleQuickFoodSelect(meal, f)} className="tag-btn text-[12px] bg-white border-gray-100 pr-8 text-brand text-brand text-brand">{f}</button>
                                                                    <button onClick={(e)=>{e.stopPropagation(); confirmDelete('quickFood', f, meal);}} className="absolute right-1 top-1/2 -translate-y-1/2 touch-target text-red-300 text-brand text-brand text-brand text-brand"><Icon name="x-circle" size={14} /></button>
                                                                </div>
                                                            ))}
                                                            <div className="flex items-center gap-1 bg-blue-100/30 pl-3 pr-1 rounded-xl h-9 border border-blue-100 text-brand text-brand text-brand text-brand">
                                                                <input value={customFoodInput[meal]} onChange={e=>setCustomFoodInput(p=>({...p, [meal]: e.target.value}))} placeholder="Âø´Êç∑..." className="bg-transparent w-12 text-[12px] outline-none text-brand text-brand text-brand" />
                                                                <button onClick={()=>handleAddCustomQuickFood(meal)} className="touch-target !w-7 !h-7 bg-[#f9991a] text-white rounded-lg text-brand text-brand"><Icon name="plus" size={14} /></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="p-4 bg-white border-t border-gray-50 pb-4 text-brand text-brand text-brand text-brand"><button onClick={handleSaveEntry} disabled={isSaving} className="primary-btn w-full shadow-lg text-white flex items-center justify-center gap-2 text-brand text-brand">{isSaving ? <><Icon name="loader-2" size={18} className="spinner" /> ÂÑ≤Â≠ò‰∏≠...</> : 'ÂÑ≤Â≠òÁ¥ÄÈåÑ'}</button></div>
                            </div>
                        </div>
                    )}

                    {/* --- Êñ∞Â¢ûË®àÁï´ÂΩàÁ™ó --- */}
                    {showPlanModal && (
                        <div className="sheet-container text-[#040316]">
                            <div className="sheet-backdrop" onClick={closeModal} />
                            <div className="sheet-content">
                                <header className="h-[64px] px-4 flex justify-between items-center border-b border-gray-50 bg-white sticky top-0 z-20 text-brand text-brand text-brand">
                                    <div className="w-10 text-brand"></div>
                                    <h3 className="text-[18px] font-bold text-[#5a6a7a]">{editingPlanId ? 'Á∑®ËºØÁõÆÊ®ô' : 'ÂïüÂãïÊñ∞ÁõÆÊ®ô'}</h3>
                                    <div onClick={closeModal} className="touch-target text-[#9caeba] text-brand text-brand text-brand text-brand text-brand text-brand text-brand text-brand"><Icon name="x" size={24} /></div>
                                </header>
                                <div className="p-4 space-y-4 no-scrollbar pb-4 text-brand text-brand text-brand text-brand">
                                    <div><span className="font-bold mb-2 block text-[#5a6a7a] text-[16px] text-brand text-brand">Ë®àÁï´ÂêçÁ®±</span><input value={newPlanTitle} onChange={e=>setNewPlanTitle(e.target.value)} placeholder="È¶ñÁàæË°ùÂà∫ 14 Â§©" className="text-[14px] w-full bg-blue-50/50 rounded-xl h-11 px-3 outline-none text-brand text-brand" /></div>
                                    <div><span className="font-bold mb-2 block text-[#5a6a7a] text-[16px] text-brand text-brand">ÁõÆÊ®ôÊó•Êúü</span><input type="date" value={newPlanDate} onChange={e=>setNewPlanDate(e.target.value)} className="text-[14px] w-full bg-blue-50/50 rounded-xl h-11 px-3 outline-none text-brand text-brand" />{!editingPlanId && <div className="flex gap-2 pt-2 text-brand text-brand text-brand text-brand">{[7, 14, 30].map(d => (<button key={d} onClick={() => { const obj = new Date(); obj.setDate(obj.getDate() + d); setNewPlanDate(obj.toISOString().split('T')[0]); }} className="tag-btn text-[12px] text-brand text-brand">+{d}Â§©</button>))}</div>}</div>
                                    <div><span className="font-bold mb-2 block text-[#5a6a7a] text-[16px] text-brand text-brand">È´îÊÖãË®≠ÂÆö</span><div className="flex items-center gap-2 text-brand text-brand text-brand"><div className="weight-input-card flex-1 p-4 bg-blue-50/50 rounded-[20px] flex flex-col items-center gap-1 text-brand text-brand"><span className="text-[11px] font-bold text-[#9caeba] uppercase text-brand text-brand text-brand">Ëµ∑Âßã</span><div className="flex items-baseline text-brand text-brand text-brand"><input type="number" step="0.1" value={newPlanBaselineWeight} onChange={e=>setNewPlanBaselineWeight(e.target.value)} placeholder="54.0" className="w-16 bg-transparent text-center text-[20px] font-bold outline-none text-brand text-brand" /><span className="text-[12px] font-bold text-[#9caeba] ml-0.5 text-brand text-brand">kg</span></div></div><div className="text-[#f9991a] opacity-30 text-brand text-brand"><Icon name="chevron-right" size={24} /></div><div className="weight-input-card flex-1 bg-orange-50/30 p-4 rounded-[20px] flex flex-col items-center gap-1 border border-orange-100 text-brand text-brand"><span className="text-[11px] font-bold text-[#f9991a] uppercase text-brand text-brand">ÁõÆÊ®ô</span><div className="flex items-baseline text-brand text-brand text-brand"><input type="number" step="0.1" value={newPlanTargetWeight} onChange={e=>setNewPlanTargetWeight(e.target.value)} placeholder="50.0" className="!text-[#f9991a] w-16 bg-transparent text-center text-[20px] font-bold outline-none text-brand text-brand" /><span className="text-[12px] font-bold text-[#f9991a] ml-0.5 text-brand text-brand text-brand">kg</span></div></div></div></div>
                                    <div className="pt-4 text-brand text-brand text-brand text-brand"><button onClick={handleCreatePlan} disabled={!newPlanDate || !newPlanTitle} className="primary-btn w-full shadow-lg font-bold tracking-widest uppercase text-brand text-brand">ÂïüÂãïË®àÁï´</button></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- ÁΩÆ‰∏≠È°ØÁ§∫ÁöÑÂà™Èô§Á¢∫Ë™çÂΩàÁ™ó --- */}
                    {showConfirmModal && (
                        <div className="fixed inset-0 z-[2000] flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={()=>setShowConfirmModal(false)} />
                            <div className="modal-center-content relative z-10 w-full max-w-[320px] bg-white rounded-[32px] p-6 shadow-2xl text-center text-brand text-brand text-brand">
                                <div className="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center text-red-500 mx-auto mb-4 text-brand text-brand text-brand">
                                    <Icon name="alert-triangle" size={32} />
                                </div>
                                <h3 className="text-[18px] font-bold mb-2 text-brand text-brand">Á¢∫Ë™çË¶ÅÂà™Èô§ÂóéÔºü</h3>
                                <p className="text-[14px] text-[#7a8b9a] leading-relaxed mb-6 text-brand text-brand text-brand text-brand">
                                    Âà™Èô§ÂæåË≥áÊñôÂ∞áÁÑ°Ê≥ïÂæ©ÂéüÔºå<br/>Ë´ãÁ¢∫Ë™çÊòØÂê¶ÁπºÁ∫åÂü∑Ë°åÔºü
                                </p>
                                <div className="flex gap-3 text-brand text-brand text-brand text-brand">
                                    <button onClick={()=>setShowConfirmModal(false)} className="flex-1 h-12 bg-gray-100 rounded-2xl font-bold text-[#5a6a7a] active:scale-95 transition-all text-brand text-brand text-brand">‰∏çÔºåÂèñÊ∂à</button>
                                    <button onClick={executeDelete} className="flex-1 h-12 bg-red-500 text-white rounded-2xl font-bold active:scale-95 transition-all shadow-lg shadow-red-200 text-brand text-brand text-brand">ÊòØÁöÑÔºåÂà™Èô§</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
