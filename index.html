<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>K-Glow Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com/"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        :root {
            --bg-color: #fbfbfe;
            --text-color: #040316; 
            --accent-color: #f9991a;
            --input-bg: #f2f4f7;
            --gray-border: #e5e7eb;
        }

        body {
            font-family: 'PingFang TC', 'Noto Sans TC', sans-serif;
            background-color: #111; 
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        #root {
            width: 100%;
            max-width: 430px; 
            height: 100vh;
            height: 100dvh; 
            background-color: var(--bg-color);
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* çµ±ä¸€è¦–è¦ºï¼šåœ“è§’ 16pxã€ç„¡é‚Šç·šã€ä¸€è‡´ç°åº• */
        input, select { 
            background-color: var(--input-bg) !important;
            border: none !important;
            border-radius: 16px !important; 
            padding: 0 16px !important; 
            font-size: 14px !important;
            outline: none !important;
            color: var(--text-color) !important;
            transition: all 0.2s ease;
        }

        textarea {
            background-color: var(--input-bg) !important;
            border: none !important;
            border-radius: 16px !important;
            padding: 12px 16px !important;
            font-size: 14px !important;
            outline: none !important;
            color: var(--text-color) !important;
            transition: all 0.2s ease;
        }
        
        input:focus, textarea:focus, select:focus {
            background-color: #ebedf0 !important;
        }

        .option-tag {
            background-color: white;
            border: 1px solid var(--gray-border) !important;
            padding: 8px 16px;
            border-radius: 16px !important; 
            font-size: 13px;
            font-weight: 500;
            color: var(--text-color);
            box-shadow: none !important;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        /* æ™‚é–“è»¸å‚ç›´å¼•å°ç·š */
        .timeline-line {
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--accent-color);
            opacity: 0.15;
            z-index: 0;
        }

        /* èƒŒæ™¯æµå‹•æ•ˆæœ */
        @keyframes bg-gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .bg-dynamic-flow {
            background: linear-gradient(135deg, #f9991a, #ffb347, #ff8c00, #f9991a);
            background-size: 400% 400%;
            animation: bg-gradient-flow 12s ease infinite;
            position: relative;
            overflow: hidden;
        }

        .energy-stream {
            position: absolute;
            width: 150%;
            height: 40%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            filter: blur(40px);
            z-index: 1;
            pointer-events: none;
        }
        .stream-1 { top: 10%; left: -25%; animation: energy-wave 8s infinite ease-in-out; }
        .stream-2 { bottom: 15%; left: -10%; animation: energy-wave 10s infinite reverse ease-in-out; }

        @keyframes energy-wave {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        .premium-shine { position: relative; overflow: hidden; }
        .premium-shine::after {
            content: '';
            position: absolute;
            top: 0; left: -100%; width: 60%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: skewX(-25deg);
            animation: advanced-shine 4s infinite ease-in-out;
        }
        @keyframes advanced-shine {
            0% { left: -100%; }
            25%, 100% { left: 100%; }
        }

        .glass { background: rgba(251, 251, 254, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .animate-progress { transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .date-input-container {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            background-color: var(--input-bg);
            border-radius: 16px; 
            height: 40px; 
        }
        
        .date-input-container input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            background: transparent;
            color: transparent;
            cursor: pointer;
            z-index: 10;
        }
    </style>

    <script>
        window.tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#9caeba',
                        accent: '#f9991a',
                        secondary: '#e9f1fb',
                        brand: '#34495e',
                        kbg: '#fbfbfe',
                        ingray: '#f2f4f7'
                    },
                    spacing: {
                        'page': '16px' 
                    },
                    borderRadius: {
                        'kxl': '16px'
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useMemo, useEffect, useRef } = React;

        // --- å…¨åŸŸçµ„ä»¶ ---
        function Icon({ name, size = 24, className = "", fill = "none" }) {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (window.lucide && wrapperRef.current) {
                    wrapperRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({
                        root: wrapperRef.current,
                        attrs: { width: size, height: size, class: className, fill: fill }
                    });
                }
            }, [name, size, className, fill]);
            return <span ref={wrapperRef} className={`inline-flex items-center justify-center shrink-0 ${className}`} style={{ width: size, height: size }} />;
        }

        // --- å¸¸æ•¸æ•¸æ“š ---
        const BODY_PARTS = ['æ ¸å¿ƒ', 'ä¸ŠåŠèº«', 'ä¸‹åŠèº«', 'å…¨èº«æµå‹•'];
        const DIET_TAGS = ['è›‹ç™½è³ªè¶³å¤ ', 'ä½é†£é£²é£Ÿ', 'è¼•é£Ÿç„¡è² æ“”', 'çå‹µé¤'];
        const DAILY_REINFORCEMENTS = [
            { name: 'æ­»èŸ²å¼ (Dead Bug)', sets: '15x3', desc: 'å•Ÿå‹•æ·±å±¤è…¹è‚Œï¼Œç©©å®šéª¨ç›†ä½ç½®ã€‚', challenge: { name: 'é€²éšæ­»èŸ²å¼ (åŠ é‡çƒ)', sets: '12x4', desc: 'æŒ‘æˆ°æ ¸å¿ƒç©©å®šæ€§èˆ‡è‚Œè€åŠ›ã€‚' } },
            { name: 'è²“ç‰›å¼ (Cat-Cow)', sets: '10x2', desc: 'æ‰¾å›è„Šæ¤é€ç¯€æµå‹•æ„Ÿï¼Œé‡‹æ”¾å£“åŠ›ã€‚', challenge: { name: 'å‹•æ…‹å¹³è¡¡è²“ç‰›å¼', sets: '8x3', desc: 'å¢åŠ å°å´å¹³è¡¡é›£åº¦ã€‚' } },
            { name: 'é³¥ç‹—å¼ (Bird-Dog)', sets: '12x3', desc: 'å»ºç«‹äº¤å‰éˆç©©å®šï¼Œå¼·åŒ–è»€å¹¹ã€‚', challenge: { name: 'æ‡¸ç©ºé³¥ç‹—å¼', sets: '6x3', desc: 'è†è“‹é›¢åœ°æŒ‘æˆ°æ¥µé™æ”¯æ’ã€‚' } },
            { name: 'è‡€æ©‹ (Glute Bridge)', sets: '20x3', desc: 'å–šé†’è‡€å¤§è‚Œï¼Œä¿è­·ä¸‹è…°æ¤ã€‚', challenge: { name: 'å–®è…³è‡€æ©‹', sets: '10x3', desc: 'å¹³è¡¡å·¦å³è‚ŒåŠ›å·®ç•°ã€‚' } },
            { name: 'å¤©éµå¼ (Swan)', sets: '8x3', desc: 'é–‹å±•èƒ¸è…”ï¼Œå¼·åŒ–ä¸ŠèƒŒé«”æ…‹ã€‚', challenge: { name: 'å¤©éµå¼ 2 å‹', sets: '10x2', desc: 'æ·±åº¦é–‹å±•èƒ¸æ¤å€åŸŸã€‚' } }
        ];
        const EXERCISE_LIBRARY = {
            'æ ¸å¿ƒåºŠ (Reformer)': [{ name: 'è¶³éƒ¨ç·´ç¿’', category: 'æ ¸å¿ƒåºŠ (Reformer)' }, { name: 'å¤§è±¡å¼', category: 'æ ¸å¿ƒåºŠ (Reformer)' }, { name: 'æ²è…¹', category: 'æ ¸å¿ƒåºŠ (Reformer)' }],
            'å‡±è¿ªæ‹‰å…‹ (Cadillac)': [{ name: 'é€ç¯€æ²å‹•', category: 'å‡±è¿ªæ‹‰å…‹ (Cadillac)' }, { name: 'èƒ¸å£æ“´å±•', category: 'å‡±è¿ªæ‹‰å…‹ (Cadillac)' }],
            'ç©©è¸æ¤… (Chair)': [{ name: 'å¤©éµå¼', category: 'ç©©è¸æ¤… (Chair)' }, { name: 'æ¨åœ°å¼', category: 'ç©©è¸æ¤… (Chair)' }],
            'å¢Šä¸Š (Mat)': [{ name: 'ç™¾æ¬¡å‘¼å¸', category: 'å¢Šä¸Š (Mat)' }, { name: 'æ­»èŸ²å¼', category: 'å¢Šä¸Š (Mat)' }]
        };
        const DEFAULT_QUICK_FOODS = {
            breakfast: ["ç„¡ç³–è±†æ¼¿", "æ°´ç…®è›‹", "é»‘å’–å•¡"],
            lunch: ["é›èƒ¸è‚‰", "ç³™ç±³é£¯", "å¥åº·é¤ç›’"],
            dinner: ["æ¸…è’¸é­š", "è±†è…", "å¤§æ‹Œèœ"],
            snacks: ["ç¶œåˆå …æœ", "å¸Œè‡˜å„ªæ ¼", "è—è“"]
        };

        const App = () => {
            // Firebase Config & Init
            const myFirebaseConfig = {
                apiKey: "AIzaSyBpCw2-cfSDaE0ABznkvULKD9sxgjlR9OI", // ä¾‹å¦‚: "AIzaSy..."
                authDomain: "health-tracker-ed193.firebaseapp.com",
                projectId: "health-tracker-ed193",
                storageBucket: "health-tracker-ed193.firebasestorage.app",
                messagingSenderId: "77615585267",
                appId: "1:77615585267:web:451f6672cc9834dc92a486" };
            const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : myFirebaseConfig;
            const isConfigReady = firebaseConfig && firebaseConfig.apiKey !== "";
            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'k-glow-tracker-vercel';

            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home'); 
            const [showEntryModal, setShowEntryModal] = useState(false);
            const [showPlanModal, setShowPlanModal] = useState(false);
            const [entryType, setEntryType] = useState('workout');
            const [showCelebration, setShowCelebration] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [confirmDelete, setConfirmDelete] = useState(null); 

            const [plans, setPlans] = useState([]);
            const [activePlanId, setActivePlanId] = useState(null);
            const [commonFoods, setCommonFoods] = useState(DEFAULT_QUICK_FOODS);
            
            const [inlineAddingMeal, setInlineAddingMeal] = useState(null);
            const [newLabelText, setNewLabelText] = useState("");
            const [historyFilterDate, setHistoryFilterDate] = useState("");

            const [customSets, setCustomSets] = useState("");
            const [isReinforcementDoneToday, setIsReinforcementDoneToday] = useState(false);
            const [isExtraChallengeMode, setIsExtraChallengeMode] = useState(false);

            // è¡¨å–®ç‹€æ…‹
            const [w_note, setWNote] = useState('');
            const [w_parts, setWParts] = useState([]);
            const [w_apparatus, setWApparatus] = useState('æ ¸å¿ƒåºŠ (Reformer)');
            const [w_exercises, setWExercises] = useState([]);
            const [w_weight, setWWeight] = useState('57.1');
            const [w_date, setWDate] = useState(new Date().toISOString().split('T')[0]);
            const [d_breakfast, setDBreakfast] = useState('');
            const [d_lunch, setDLunch] = useState('');
            const [d_dinner, setDDinner] = useState('');
            const [d_snacks, setDSnacks] = useState('');
            const [d_water, setDWater] = useState(2000);
            const [d_tags, setDTags] = useState([]);
            const [d_date, setDDate] = useState(new Date().toISOString().split('T')[0]);

            const [newPlanTitle, setNewPlanTitle] = useState('');
            const [newPlanDate, setNewPlanDate] = useState('');
            const [newPlanTargetWeight, setNewPlanTargetWeight] = useState('');

            // è¨ˆç®—å±¬æ€§
            const activePlan = useMemo(() => plans.find(p => p.id === activePlanId) || null, [plans, activePlanId]);
            const latestWeight = useMemo(() => activePlan?.workoutEntries?.[0]?.weight || activePlan?.baselineWeight || 57.1, [activePlan]);
            const daysLeft = useMemo(() => {
                if (!activePlan) return 0;
                const target = new Date(activePlan.targetDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0); target.setHours(0, 0, 0, 0);
                const diffTime = target - today;
                return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            }, [activePlan]);
            
            const todayReinforcement = useMemo(() => {
                const item = DAILY_REINFORCEMENTS[new Date().getDate() % DAILY_REINFORCEMENTS.length];
                return isExtraChallengeMode ? item.challenge : item;
            }, [isExtraChallengeMode]);

            const isDietValid = useMemo(() => activePlan && (Number(d_water) >= 0) && (d_breakfast.trim() || d_lunch.trim() || d_dinner.trim() || d_snacks.trim()), [d_water, d_breakfast, d_lunch, d_dinner, d_snacks, activePlan]);
            const isWorkoutValid = useMemo(() => activePlan && (w_parts.length > 0 || w_exercises.length > 0), [w_parts, w_exercises, activePlan]);

            // --- æ“ä½œå‡½æ•¸ ---
            const savePlanToCloud = async (updated) => {
                if (!user || !db || !updated.id) return;
                await setDoc(doc(db, 'artifacts', currentAppId, 'users', user.uid, 'plans', updated.id), updated);
            };

            const handleCreatePlan = async () => {
                if (!newPlanTitle || !newPlanDate) return;
                const newId = `p-${Date.now()}`;
                await savePlanToCloud({ id: newId, title: newPlanTitle, targetDate: newPlanDate, targetWeight: parseFloat(newPlanTargetWeight) || 0, baselineWeight: parseFloat(latestWeight), workoutEntries: [], dietEntries: [] });
                setActivePlanId(newId); setShowPlanModal(false); setView('home');
            };

            const handleSetPresetDate = (days) => {
                const date = new Date(); date.setDate(date.getDate() + days);
                setNewPlanDate(date.toISOString().split('T')[0]);
            };

            const handleCompleteRecommendation = async () => {
                if (!activePlan) return;
                const now = new Date();
                const newEntry = { 
                    id: Date.now(), date: now.toISOString().split('T')[0], 
                    time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 
                    displayDate: `${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`, 
                    note: `æ‰“å¡ï¼š${todayReinforcement.name}`, bodyParts: ['æ ¸å¿ƒ'], apparatus: ['å¢Šä¸Š (Mat)'], 
                    exercises: [{ name: todayReinforcement.name, sets: customSets || todayReinforcement.sets, category: 'å¢Šä¸Š (Mat)' }], 
                    weight: parseFloat(latestWeight) || 0 
                };
                await savePlanToCloud({ ...activePlan, workoutEntries: [newEntry, ...(activePlan.workoutEntries || [])].sort((a,b) => new Date(b.date) - new Date(a.date)) });
                setIsReinforcementDoneToday(true); setCustomSets(""); setShowCelebration(true); setTimeout(() => setShowCelebration(false), 3000);
            };

            const handleSaveDiet = async () => {
                if (!activePlan) return;
                const now = new Date();
                const entry = { id: editingId || Date.now(), date: d_date, time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), displayDate: `${parseInt(d_date.split('-')[1])}æœˆ${parseInt(d_date.split('-')[2])}æ—¥`, breakfast: d_breakfast, lunch: d_lunch, dinner: d_dinner, snacks: d_snacks, water: Number(d_water), tags: d_tags };
                const list = editingId ? activePlan.dietEntries.map(e => e.id === editingId ? entry : e) : [entry, ...(activePlan.dietEntries || [])];
                await savePlanToCloud({ ...activePlan, dietEntries: list.sort((a,b) => new Date(b.date) - new Date(a.date)) });
                closeModal(); setShowCelebration(true); setTimeout(() => setShowCelebration(false), 3000);
            };

            const handleSaveWorkout = async () => {
                if (!activePlan) return;
                const entry = { id: editingId || Date.now(), date: w_date, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), displayDate: `${parseInt(w_date.split('-')[1])}æœˆ${parseInt(w_date.split('-')[2])}æ—¥`, note: w_note, bodyParts: w_parts, apparatus: Array.from(new Set(w_exercises.map(ex => ex.category))), exercises: w_exercises, weight: parseFloat(w_weight) };
                const list = editingId ? (activePlan.workoutEntries || []).map(e => e.id === editingId ? entry : e) : [entry, ...(activePlan.workoutEntries || [])];
                await savePlanToCloud({ ...activePlan, workoutEntries: list.sort((a,b) => new Date(b.date) - new Date(a.date)) });
                closeModal(); setShowCelebration(true); setTimeout(() => setShowCelebration(false), 3000);
            };

            const executeDelete = async () => {
                if (!confirmDelete || !activePlan) return;
                const { type, id } = confirmDelete;
                if (type === 'plan') {
                    await deleteDoc(doc(db, 'artifacts', currentAppId, 'users', user.uid, 'plans', id));
                } else {
                    const key = type === 'workout' ? 'workoutEntries' : 'dietEntries';
                    const updatedList = activePlan[key].filter(e => e.id !== id);
                    await savePlanToCloud({ ...activePlan, [key]: updatedList });
                }
                setConfirmDelete(null);
            };

            const closeModal = () => { setShowEntryModal(false); setShowPlanModal(false); setInlineAddingMeal(null); setEditingId(null); setWNote(''); setWParts([]); setWExercises([]); setDBreakfast(''); setDLunch(''); setDDinner(''); setDSnacks(''); setDWater(2000); setDTags([]); setNewPlanTitle(''); setNewPlanDate(''); setNewPlanTargetWeight(''); };
            const handleQuickAddFood = (mealSetter, currentVal, foodName) => { mealSetter(`${currentVal}${currentVal.trim() ? 'ã€' : ''}${foodName}`); };
            const handleAddLabelInline = async (mealKey) => { if (!newLabelText.trim()) return; const updatedFoods = { ...commonFoods, [mealKey]: [...(commonFoods[mealKey] || []), newLabelText.trim()] }; setCommonFoods(updatedFoods); await setDoc(doc(db, 'artifacts', currentAppId, 'users', user.uid, 'settings', 'commonFoods'), updatedFoods); setNewLabelText(""); setInlineAddingMeal(null); };
            const handleRemoveLabelInline = async (mealKey, labelIndex) => { const updatedFoods = { ...commonFoods, [mealKey]: commonFoods[mealKey].filter((_, i) => i !== labelIndex) }; setCommonFoods(updatedFoods); await setDoc(doc(db, 'artifacts', currentAppId, 'users', user.uid, 'settings', 'commonFoods'), updatedFoods); };
            const handleEditWorkout = (entry) => { setEntryType('workout'); setEditingId(entry.id); setWNote(entry.note); setWParts(entry.bodyParts || []); setWExercises(entry.exercises || []); setWWeight(entry.weight?.toString() || '57.1'); setWDate(entry.date); setShowEntryModal(true); };
            const handleEditDiet = (entry) => { setEntryType('diet'); setEditingId(entry.id); setDBreakfast(entry.breakfast || ''); setDLunch(entry.lunch || ''); setDDinner(entry.dinner || ''); setDSnacks(entry.snacks || ''); setDWater(entry.water || 2000); setDTags(entry.tags || []); setDDate(entry.date); setShowEntryModal(true); };

            // --- Firebase åˆå§‹åŒ– ---
            useEffect(() => {
                if (!isConfigReady) { setLoading(false); return; }
                const initializeFirebase = async () => {
                    try {
                        const appInstance = initializeApp(firebaseConfig);
                        const authInstance = getAuth(appInstance);
                        const firestoreInstance = getFirestore(appInstance);
                        setDb(firestoreInstance);
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(authInstance, __initial_auth_token);
                        else await signInAnonymously(authInstance);
                        onAuthStateChanged(authInstance, (u) => { setUser(u); if (!u) setLoading(false); });
                    } catch (e) { console.error(e); setLoading(false); }
                };
                initializeFirebase();
            }, []);

            // --- æ•¸æ“šç›£è½ ---
            useEffect(() => {
                if (!user || !db) return;
                const plansRef = collection(db, 'artifacts', currentAppId, 'users', user.uid, 'plans');
                const unsubPlans = onSnapshot(plansRef, (snap) => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setPlans(list.sort((a,b) => new Date(b.targetDate) - new Date(a.targetDate)));
                    setLoading(false);
                }, () => setLoading(false));

                const foodRef = doc(db, 'artifacts', currentAppId, 'users', user.uid, 'settings', 'commonFoods');
                const unsubFoods = onSnapshot(foodRef, (docSnap) => {
                    if (docSnap.exists()) setCommonFoods(docSnap.data());
                    else setDoc(foodRef, DEFAULT_QUICK_FOODS);
                });
                return () => { unsubPlans(); unsubFoods(); };
            }, [user, db]);

            // --- æ™‚é–“è»¸æ¸²æŸ“ ---
            const renderTimeline = (entries, type) => {
                let lastDate = "";
                const filtered = historyFilterDate ? entries.filter(e => e.date === historyFilterDate) : entries;
                return filtered.map((entry) => {
                    const isNewDay = entry.date !== lastDate;
                    lastDate = entry.date;
                    const [y, m, d] = entry.date.split('-');
                    return (
                        <div key={entry.id} className="relative flex flex-col px-page">
                            <div className="timeline-line"></div>
                            {isNewDay && (
                                <div className="flex items-center gap-3 py-4 z-10">
                                    <div className="w-2.5 h-2.5 rounded-full bg-accent ring-4 ring-orange-100 shadow-[0_0_12px_rgba(249,153,26,0.3)]"></div>
                                    <h4 className="text-[15px] font-bold text-brand tracking-tighter uppercase">{parseInt(m)}æœˆ{parseInt(d)}æ—¥ <span className="text-[10px] text-primary ml-1 opacity-50 font-normal">TIMELINE</span></h4>
                                </div>
                            )}
                            <div className={`flex gap-4 ${isNewDay ? '' : 'pt-2'}`}>
                                <div className="w-[10px] shrink-0"></div>
                                <div className="flex-1 mb-6 bg-white rounded-kxl p-5 border border-primary/5 shadow-sm relative z-10 text-brand">
                                    <div className="flex justify-between items-start mb-3">
                                        <div className="flex items-center gap-2">
                                            <div className="w-1.5 h-1.5 rounded-full bg-accent/30"></div>
                                            <div className="flex items-center gap-1 text-[10px] font-bold text-primary opacity-60 bg-ingray px-2 py-0.5 rounded-kxl">
                                                <Icon name="clock" size={10} /><span>{entry.time || '--:--'}</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button onClick={() => type === 'workout' ? handleEditWorkout(entry) : handleEditDiet(entry)} className="p-1.5 text-primary active:scale-90"><Icon name="edit-2" size={14} /></button>
                                            <button onClick={() => setConfirmDelete({type, id: entry.id})} className="p-1.5 text-primary active:scale-90 hover:text-red-400"><Icon name="trash-2" size={14} /></button>
                                        </div>
                                    </div>
                                    {type === 'workout' ? (
                                        <div className="space-y-2">
                                            {entry.exercises?.map((ex, i) => (<div key={i} className="flex justify-between items-center text-[14px]"><span className="font-medium text-brand">{ex.name}</span><span className="text-accent font-bold px-2 py-0.5 bg-orange-50 rounded-kxl text-[12px]">{ex.sets}</span></div>))}
                                            {entry.note && <p className="text-[12px] text-gray-400 italic mt-2 pt-2 border-t border-gray-50">"{entry.note}"</p>}
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            <div className="flex flex-col gap-2 text-brand text-brand">
                                                {entry.breakfast && <div className="flex items-start gap-3"><Icon name="coffee" size={14} className="mt-1 text-primary opacity-40"/><p className="text-[14px] leading-relaxed text-brand">{entry.breakfast}</p></div>}
                                                {entry.lunch && <div className="flex items-start gap-3"><Icon name="sun" size={14} className="mt-1 text-primary opacity-40"/><p className="text-[14px] leading-relaxed text-brand">{entry.lunch}</p></div>}
                                                {entry.dinner && <div className="flex items-start gap-3"><Icon name="moon" size={14} className="mt-1 text-primary opacity-40"/><p className="text-[14px] leading-relaxed text-brand">{entry.dinner}</p></div>}
                                                {entry.snacks && <div className="flex items-start gap-3"><Icon name="cookie" size={14} className="mt-1 text-primary opacity-40"/><p className="text-[14px] opacity-60 leading-relaxed text-brand">{entry.snacks}</p></div>}
                                            </div>
                                            <div className="pt-2 border-t border-gray-50 flex justify-between items-center">
                                                <div className="flex gap-1">{(entry.tags || []).map(t => <span key={t} className="text-[11px] font-bold text-primary opacity-60">#{t}</span>)}</div>
                                                <div className="flex items-center gap-1 text-[11px] font-bold text-accent"><Icon name="droplets" size={12}/>{entry.water}cc</div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                });
            };

            if (loading) return <div className="h-full flex flex-col items-center justify-center bg-[#f9991a] text-white gap-4"><Icon name="loader-2" className="animate-spin" size={32} /><p className="text-[14px] font-bold uppercase tracking-widest text-brand">ç²¾ä¿® App é‚è¼¯ä¸­...</p></div>;

            return (
                <div className={`h-full flex flex-col relative select-none transition-all duration-700 ${view === 'home' ? 'bg-dynamic-flow' : 'bg-[#fbfbfe]'}`}>
                    {view === 'home' && (<><div className="energy-stream stream-1"></div><div className="energy-stream stream-2"></div></>)}

                    {/* å½ˆçª—ï¼šæˆå°±èˆ‡åˆªé™¤ */}
                    {showCelebration && (
                        <div className="fixed inset-0 z-[300] flex items-center justify-center p-page animate-in fade-in zoom-in duration-300">
                            <div className="absolute inset-0 bg-[#040316]/60 backdrop-blur-md" />
                            <div className="w-full max-w-[300px] bg-white rounded-kxl p-8 flex flex-col items-center text-center relative z-10 shadow-2xl border border-white/20">
                                <div className="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mb-6 animate-bounce"><Icon name="trophy" size={48} className="text-accent" /></div>
                                <h2 className="text-[22px] font-bold mb-2 text-brand">æˆå°±é”æˆï¼âœ¨</h2>
                                <button onClick={() => setShowCelebration(false)} className="w-full h-[44px] bg-accent text-white rounded-kxl font-bold active:scale-95 transition-all shadow-lg">æ”¶ä¸‹è®šç¾</button>
                            </div>
                        </div>
                    )}
                    {confirmDelete && (
                        <div className="fixed inset-0 z-[400] flex items-center justify-center p-page animate-in fade-in duration-200">
                            <div className="absolute inset-0 bg-[#040316]/40 backdrop-blur-sm" />
                            <div className="w-full max-w-[280px] bg-white rounded-kxl p-6 text-center z-10 shadow-2xl border border-primary/10">
                                <Icon name="alert-circle" size={40} className="text-red-400 mx-auto mb-4" />
                                <h3 className="text-[18px] font-bold text-brand mb-2">ç¢ºå®šåˆªé™¤å—ï¼Ÿ</h3>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setConfirmDelete(null)} className="flex-1 h-[44px] bg-ingray rounded-kxl text-brand font-bold text-[14px]">å–æ¶ˆ</button>
                                    <button onClick={executeDelete} className="flex-1 h-[44px] bg-red-500 text-white rounded-kxl font-bold text-[14px]">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Header 44px */}
                    <header className={`px-page h-[44px] shrink-0 sticky top-0 z-30 flex items-center transition-all duration-500 ${view === 'home' ? 'text-white' : 'text-brand bg-[#fbfbfe]/80 backdrop-blur-lg border-b border-primary/10'}`}>
                        {view === 'home' ? (
                            <div className="flex items-center gap-2 w-full text-white">
                                <div onClick={() => setView('home')} className="active:scale-95 transition-transform flex items-center gap-2 overflow-hidden flex-1">
                                    <h1 className="text-[15px] font-bold tracking-tight truncate">{activePlan ? `${activePlan.title} | å‰©é¤˜ ${daysLeft} å¤©` : "é–‹å•Ÿå¦³çš„è›»è®Šä¹‹æ—…"}</h1>
                                    <span className="text-[10px] font-medium opacity-80 whitespace-nowrap bg-white/20 px-2 py-0.5 rounded-full">ä»Šå¤©ä¹Ÿè¦é–ƒè€€å‹•äºº âœ¨</span>
                                </div>
                            </div>
                        ) : (
                            <div className="flex items-center justify-between w-full text-brand text-brand">
                                <div className="flex items-center gap-3">
                                    <button onClick={() => {setView('home'); setHistoryFilterDate("");}} className="active:scale-90 text-brand"><Icon name="chevron-left" size={20}/></button>
                                    <h1 className="text-[16px] font-bold tracking-tight">{view === 'workout_history' ? 'è¨“ç·´æ™‚é–“è»¸' : view === 'diet_history' ? 'é£²é£Ÿç”Ÿæ´»èªŒ' : 'è¨ˆç•«ç®¡ç†'}</h1>
                                </div>
                                {(view === 'workout_history' || view === 'diet_history') && (
                                    <div className="relative">
                                        <input type="date" value={historyFilterDate} onChange={(e) => setHistoryFilterDate(e.target.value)} className="!bg-transparent !p-0 w-8 h-8 opacity-0 absolute inset-0 z-20 cursor-pointer" />
                                        <div className={`w-8 h-8 rounded-kxl flex items-center justify-center transition-all ${historyFilterDate ? 'bg-accent text-white shadow-md' : 'bg-ingray text-brand opacity-60'}`}><Icon name={historyFilterDate ? "filter-x" : "search"} size={16} /></div>
                                    </div>
                                )}
                            </div>
                        )}
                    </header>

                    <main className="flex-1 overflow-y-auto py-6 space-y-4 no-scrollbar pb-[120px] text-brand z-10">
                        {view === 'home' ? (
                            <div className="px-page space-y-4">
                                {activePlan ? (
                                    <>
                                        <section className="bg-white/90 backdrop-blur-md rounded-kxl p-5 space-y-5 shadow-sm text-brand">
                                            <h3 className="text-[16px] font-bold uppercase tracking-widest opacity-80 text-brand">æ•¸æ“šå„€è¡¨æ¿</h3>
                                            <div className="flex items-center justify-between">
                                                <div className="space-y-1"><p className="text-[12px] font-medium text-primary uppercase">ç•¶å‰é«”é‡</p><p className="text-[28px] font-bold tracking-tighter leading-none text-brand text-brand">{latestWeight} <span className="text-[14px] font-normal opacity-60 text-brand">kg</span></p></div>
                                                <div className="text-right space-y-1 text-brand text-brand"><p className="text-[12px] font-medium text-primary uppercase">è·é›¢ç›®æ¨™</p><p className="text-[28px] font-bold text-accent tracking-tighter leading-none text-brand">{(latestWeight - (activePlan?.targetWeight || 0)).toFixed(1)} <span className="text-[14px] font-normal opacity-60">kg</span></p></div>
                                            </div>
                                            <div className="w-full h-3 bg-secondary rounded-full overflow-hidden border border-primary/5 shadow-inner"><div className="h-full bg-accent animate-progress" style={{ width: `${activePlan ? Math.max(10, Math.min(100, (1 - (latestWeight - activePlan.targetWeight) / (activePlan.baselineWeight - activePlan.targetWeight || 1)) * 100)) : 0}%` }} /></div>
                                        </section>
                                        <section className={`bg-white/90 backdrop-blur-md rounded-kxl border border-white/20 shadow-sm transition-all duration-500 overflow-hidden ${isReinforcementDoneToday ? 'p-0' : 'p-5'}`}>
                                            {isReinforcementDoneToday ? (
                                                <div className="p-10 flex flex-col items-center text-center space-y-5 animate-in fade-in zoom-in duration-500 text-brand text-brand text-brand text-brand text-brand">
                                                    <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center text-green-500 shadow-sm"><Icon name="party-popper" size={32} /></div>
                                                    <h3 className="text-[22px] font-bold mb-2">å¦³ä»Šå¤©è¶…æ£’çš„ï¼ğŸ’ƒ</h3>
                                                    <button onClick={() => {setIsExtraChallengeMode(true); setIsReinforcementDoneToday(false);}} className="premium-shine w-full h-[44px] bg-gradient-to-r from-brand to-[#5a7da0] text-white rounded-kxl font-bold active:scale-95 transition-all shadow-lg">
                                                        <Icon name="zap" size={16} /> æŒ‘æˆ°é€²éšç‰ˆï¼Ÿ
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="space-y-6 animate-in slide-in-from-bottom-2 text-brand">
                                                    <div className="space-y-3">
                                                        <div className="flex justify-between items-center text-brand text-brand text-brand text-brand"><h3 className="text-[16px] font-bold uppercase tracking-widest opacity-80 text-brand">ä»Šæ—¥è£œå¼·å»ºè­°</h3>{isExtraChallengeMode && <span className="bg-brand text-white text-[10px] font-bold px-3 py-1 rounded-kxl uppercase tracking-widest">ADVANCED</span>}</div>
                                                        <div className="bg-white/60 border border-accent/10 p-5 rounded-kxl space-y-2 text-brand text-brand text-brand text-brand">
                                                            <h2 className="text-[24px] font-bold leading-tight">{todayReinforcement.name}</h2>
                                                            <p className="text-gray-500 text-[14px] font-medium italic">â€œ{todayReinforcement.desc}â€</p>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-2 text-brand text-brand text-brand">
                                                        <p className="text-[13px] font-bold uppercase tracking-widest opacity-60 ml-1">åŸ·è¡Œç›®æ¨™</p>
                                                        <div className="flex items-center gap-3 text-brand">
                                                            <div className="flex-1 flex items-center bg-ingray rounded-kxl px-4 h-[40px] shadow-inner">
                                                                <Icon name="list-checks" size={16} className="text-primary mr-2" />
                                                                <input value={customSets} onChange={(e) => setCustomSets(e.target.value)} className="w-full bg-transparent outline-none !p-0 font-bold h-full" placeholder={`å»ºè­°: ${todayReinforcement.sets}`} />
                                                            </div>
                                                            <a href={`https://www.youtube.com/results?search_query=çš®æ‹‰ææ–¯+${todayReinforcement.name.split(' (')[0]}`} target="_blank" rel="noreferrer" className="w-12 h-[40px] bg-white border border-primary/10 rounded-kxl flex items-center justify-center text-red-500 active:scale-90 shadow-sm text-brand text-brand"><Icon name="youtube" size={24} /></a>
                                                        </div>
                                                    </div>
                                                    <button onClick={handleCompleteRecommendation} className="w-full h-[44px] bg-accent text-white rounded-kxl font-bold shadow-lg active:scale-95 transition-all text-[16px] shadow-orange-100"><Icon name="check-circle" size={20} /> æ‰“å¡å®Œæˆ</button>
                                                </div>
                                            )}
                                        </section>
                                    </>
                                ) : (
                                    <section onClick={() => setShowPlanModal(true)} className="bg-white/90 backdrop-blur-md rounded-kxl p-10 border-dashed border-2 border-white/40 flex flex-col items-center justify-center gap-4 cursor-pointer text-brand"><Icon name="flag" size={32} className="text-accent text-brand" /><h2 className="text-[20px] font-bold text-brand">å•Ÿå‹•è¨ˆç•«è¦‹è­‰æ”¹è®Š</h2><button className="mt-4 px-8 h-[44px] bg-accent text-white rounded-kxl text-[14px] font-bold shadow-orange-100 shadow-lg text-brand">ç«‹å³è¨­å®šç›®æ¨™</button></section>
                                )}
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setView('workout_history')} className="bg-white/90 backdrop-blur-md rounded-kxl p-5 flex flex-col items-center gap-3 active:scale-95 transition-all shadow-sm text-brand">
                                        <div className="w-12 h-12 rounded-kxl bg-accent/10 flex items-center justify-center text-accent border border-accent/20"><Icon name="dumbbell" size={24}/></div>
                                        <p className="text-[16px] font-bold uppercase">è¨“ç·´ç´€éŒ„</p><p className="text-[14px] text-accent font-bold">{activePlan?.workoutEntries?.length || 0} ç­†</p>
                                    </button>
                                    <button onClick={() => setView('diet_history')} className="bg-white/90 backdrop-blur-md rounded-kxl p-5 flex flex-col items-center gap-3 active:scale-95 transition-all shadow-sm text-brand">
                                        <div className="w-12 h-12 rounded-kxl bg-accent/10 flex items-center justify-center text-accent border border-accent/20 text-brand text-brand text-brand"><Icon name="utensils" size={24}/></div>
                                        <p className="text-[16px] font-bold uppercase text-brand">é£²é£Ÿæ—¥èªŒ</p><p className="text-[14px] text-accent font-bold">{activePlan?.dietEntries?.length || 0} ç­†</p>
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <section className="space-y-4 pb-12 animate-in fade-in duration-500 text-brand text-brand">
                                {view === 'plan_manage' ? (
                                    <div className="px-page space-y-4 text-brand">
                                        <button onClick={() => {setEditingId(null); setShowPlanModal(true);}} className="w-full py-8 bg-white rounded-kxl border-2 border-dashed border-primary/30 text-primary flex flex-col items-center gap-2 active:scale-95 transition-all shadow-sm text-brand text-brand"><Icon name="plus" size={32} className="text-accent"/><span className="font-bold text-[16px] uppercase tracking-widest text-brand">æ–°å¢ç›®æ¨™è¨ˆç•«</span></button>
                                        {plans.map(p => (
                                            <div key={p.id} className={`bg-white rounded-kxl border transition-all overflow-hidden shadow-sm ${activePlanId === p.id ? 'border-accent border-2 shadow-lg' : 'border-primary/30'}`}>
                                                <div className="px-5 pt-5 pb-3 flex justify-between items-start relative text-brand text-brand">
                                                    <div className="flex items-center gap-2 pr-16 text-brand"><h3 className="text-[16px] font-bold leading-tight truncate">{p.title}</h3>{activePlanId === p.id && <span className="bg-[#ffeb3b] text-brand text-[10px] font-bold px-2 py-0.5 rounded-kxl uppercase whitespace-nowrap">åŸ·è¡Œä¸­</span>}</div>
                                                    <button onClick={() => setConfirmDelete({type:'plan', id: p.id})} className="p-2 text-primary opacity-40 active:scale-90 absolute right-4 top-4 hover:text-red-400 text-brand text-brand text-brand text-brand text-brand text-brand"><Icon name="trash-2" size={18}/></button>
                                                </div>
                                                <div className="px-5 pb-5 space-y-4 text-brand">
                                                    <div className="bg-secondary/40 rounded-kxl p-3 grid grid-cols-2 gap-2 border border-primary/10">
                                                        <div className="flex flex-col gap-1 border-r border-primary/10 text-brand text-brand text-brand"><span className="text-[10px] font-bold text-primary uppercase">ç›®æ¨™é«”é‡</span><div className="flex items-center gap-1.5"><Icon name="target" size={14} className="text-accent" /><span className="text-[15px] font-bold text-brand">{p.targetWeight} <span className="text-[10px] opacity-60">KG</span></span></div></div>
                                                        <div className="flex flex-col gap-1 pl-2 text-brand text-brand"><span className="text-[10px] font-bold text-primary uppercase text-brand">æˆªæ­¢æ—¥æœŸ</span><div className="flex items-center gap-1.5 text-brand text-brand text-brand"><Icon name="calendar" size={14} className="text-primary" /><span className="text-[15px] font-bold text-brand">{p.targetDate.split('-').slice(1).join('/')}</span></div></div>
                                                    </div>
                                                    {activePlanId !== p.id && (<button onClick={() => {setActivePlanId(p.id); setView('home');}} className="w-full h-[44px] bg-brand text-white rounded-kxl text-[14px] font-bold active:scale-95 mt-2 shadow-md">å•Ÿå‹•è¨ˆç•«</button>)}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : renderTimeline(view === 'workout_history' ? activePlan?.workoutEntries || [] : activePlan?.dietEntries || [], view === 'workout_history' ? 'workout' : 'diet')}
                            </section>
                        )}
                    </main>

                    {/* Toolbar å­—ç´š 14px & é–“è· 16px */}
                    <nav className="absolute bottom-[16px] left-[16px] right-[16px] h-[72px] glass rounded-kxl shadow-2xl border border-white/20 flex justify-around items-center px-4 z-40 text-brand text-brand">
                        <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1 transition-all ${view === 'home' ? 'text-accent scale-110' : 'text-brand/70 active:scale-95'}`}><Icon name="home" size={22} fill={view === 'home' ? 'currentColor' : 'none'} /><span className="text-[14px] font-bold">é¦–é </span></button>
                        <button onClick={() => setView('workout_history')} className={`flex flex-col items-center gap-1 transition-all ${view === 'workout_history' ? 'text-accent scale-110' : 'text-brand/70 active:scale-95'}`}><Icon name="dumbbell" size={22} /><span className="text-[14px] font-bold">è¨“ç·´</span></button>
                        <button onClick={() => { setEntryType('diet'); setEditingId(null); setShowEntryModal(true); }} className="mx-2 bg-accent w-12 h-12 rounded-kxl flex items-center justify-center text-white shadow-lg active:scale-90 transition-all -translate-y-4 border-2 border-white shadow-orange-100"><Icon name="plus" size={28} /></button>
                        <button onClick={() => setView('diet_history')} className={`flex flex-col items-center gap-1 transition-all ${view === 'diet_history' ? 'text-accent scale-110' : 'text-brand/70 active:scale-95'}`}><Icon name="utensils" size={22} /><span className="text-[14px] font-bold">é£²é£Ÿ</span></button>
                        <button onClick={() => setView('plan_manage')} className={`flex flex-col items-center gap-1 transition-all ${view === 'plan_manage' ? 'text-accent scale-110' : 'text-brand/70 active:scale-95'}`}><Icon name="clipboard" size={22} /><span className="text-[14px] font-bold">è¨ˆç•«</span></button>
                    </nav>

                    {/* Entry Modal: åº•éƒ¨å›ºå®šæŒ‰éˆ• + å³ä¸Šè§’ X */}
                    {showEntryModal && (
                        <div className="absolute inset-0 z-[110] flex items-end animate-in fade-in duration-300 text-brand">
                            <div className="absolute inset-0 bg-[#040316]/20 backdrop-blur-[4px]" onClick={closeModal} />
                            <div className="w-full bg-white rounded-t-kxl h-[85vh] z-10 flex flex-col animate-in slide-in-from-bottom-full duration-500 shadow-2xl overflow-hidden text-brand">
                                <header className="px-6 h-[56px] border-b border-primary/5 flex justify-between items-center bg-white sticky top-0 z-20 text-brand">
                                    <div className="flex bg-ingray p-1 rounded-kxl text-brand text-brand text-brand"><button onClick={() => setEntryType('workout')} className={`px-8 h-[32px] rounded-kxl text-[12px] font-medium transition-all ${entryType === 'workout' ? 'bg-white text-brand shadow-sm' : 'text-primary'}`}>é‹å‹•</button><button onClick={() => setEntryType('diet')} className={`px-8 h-[32px] rounded-kxl text-[12px] font-medium transition-all ${entryType === 'diet' ? 'bg-white text-brand shadow-sm' : 'text-primary'}`}>é£²é£Ÿ</button></div>
                                    <button onClick={closeModal} className="p-2 text-primary active:scale-90 hover:text-brand"><Icon name="x" size={24}/></button>
                                </header>
                                <div className="flex-1 overflow-y-auto px-6 pt-6 pb-[100px] space-y-8 no-scrollbar text-brand text-brand">
                                    <div className="space-y-2 text-brand text-brand text-brand"><p className="text-[16px] font-bold uppercase tracking-widest ml-1">ç´€éŒ„æ—¥æœŸ</p><div className="date-input-container shadow-sm"><input type="date" value={entryType==='workout'?w_date:d_date} onChange={e=>entryType==='workout'?setWDate(e.target.value):setDDate(e.target.value)} className="w-full bg-transparent font-bold text-accent outline-none h-full text-brand text-brand" /><div className="absolute right-4 pointer-events-none opacity-40 text-brand text-brand"><Icon name="calendar" size={18}/></div></div></div>
                                    {entryType === 'diet' && (
                                        <div className="space-y-2 text-brand">
                                            <p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand">æ¯æ—¥é£²æ°´</p>
                                            <div className="bg-ingray rounded-kxl p-5 flex items-center justify-between shadow-inner text-brand">
                                                <div className="flex items-center gap-4 text-brand text-brand"><Icon name="droplets" size={24} className="text-accent" /><div className="flex items-center text-brand text-brand"><input type="number" value={d_water} onChange={e=>setDWater(e.target.value === '' ? '' : Number(e.target.value))} className="w-20 bg-transparent text-[28px] font-bold outline-none !p-0" /><span className="text-[14px] font-bold text-primary ml-1">cc</span></div></div>
                                                <div className="flex gap-2 text-brand">
                                                    <button onClick={()=>setDWater(Math.max(0,(Number(d_water)||0)-250))} className="w-11 h-[40px] bg-white border border-primary/10 rounded-kxl flex items-center justify-center text-xl active:scale-90 text-brand">-</button>
                                                    <button onClick={()=>setDWater((Number(d_water)||0)+250)} className="w-11 h-11 bg-accent rounded-kxl flex items-center justify-center text-white text-xl active:scale-90 shadow-md shadow-orange-100 text-brand">+</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {entryType === 'workout' ? (
                                        <>
                                            <div className="space-y-2 text-brand text-brand text-brand"><p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand">ç•¶å‰é«”é‡</p><div className="flex items-center bg-ingray rounded-kxl px-4 h-[40px] shadow-inner text-brand"><input type="number" step="0.1" value={w_weight} onChange={e=>setWWeight(e.target.value)} className="w-full bg-transparent font-bold outline-none !p-0 h-full text-brand" /><span className="text-[12px] font-bold opacity-30 ml-2">KG</span></div></div>
                                            <div className="space-y-2 text-brand text-brand text-brand"><p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand">è¨“ç·´éƒ¨ä½</p><div className="flex gap-2 flex-wrap text-brand">{BODY_PARTS.map(p => <button key={p} onClick={() => setWParts(v => v.includes(p) ? v.filter(i=>i!==p) : [...v,p])} className={`px-5 h-[40px] rounded-kxl text-[14px] font-bold border transition-all ${w_parts.includes(p) ? 'bg-brand text-white border-brand shadow-md' : 'bg-white border-gray-200 text-primary'}`}>{p}</button>)}</div></div>
                                            <div className="space-y-2 text-brand text-brand">
                                                <p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand">å‹•ä½œå…§å®¹</p>
                                                <div className="bg-ingray/50 rounded-kxl p-4 space-y-4 border border-primary/5 shadow-inner text-brand">
                                                    <div className="flex overflow-x-auto no-scrollbar gap-2 flex-nowrap pb-2 text-brand text-brand">
                                                        {Object.keys(EXERCISE_LIBRARY).map(t => (<button key={t} onClick={() => setWApparatus(t)} className={`px-4 h-[40px] rounded-kxl text-[12px] font-bold border transition-all whitespace-nowrap ${w_apparatus === t ? 'bg-brand text-white shadow-md' : 'bg-white border-gray-200 text-primary'}`}>{t}</button>))}
                                                    </div>
                                                    <div className="grid grid-cols-1 gap-3 pt-2 text-brand">
                                                        {EXERCISE_LIBRARY[w_apparatus]?.map(ex => { 
                                                            const idx = w_exercises.findIndex(i => i.name === ex.name && i.category === w_apparatus); 
                                                            const active = idx !== -1; 
                                                            return (
                                                                <div key={ex.name} className={`bg-white rounded-kxl border p-3 flex flex-col gap-2 transition-all ${active ? 'border-accent shadow-sm' : 'border-primary/5'}`} onClick={() => active ? setWExercises(v=>v.filter((_,i)=>i!==idx)) : setWExercises([...w_exercises, { name: ex.name, sets: '', category: w_apparatus }])}>
                                                                    <div className="flex justify-between items-center text-brand text-brand text-brand text-brand text-brand">
                                                                        <div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all ${active ? 'bg-accent text-white' : 'bg-ingray text-primary'}`}>{active ? <Icon name="check" size={16}/> : <Icon name="plus" size={16}/>}</div><span className="font-bold text-[14px] text-brand">{ex.name}</span></div>
                                                                        <a href={`https://www.youtube.com/results?search_query=çš®æ‹‰ææ–¯+${ex.name.split(' (')[0]}`} target="_blank" rel="noreferrer" className="p-2 text-red-500 active:scale-90 text-brand text-brand text-brand"><Icon name="youtube" size={18}/></a>
                                                                    </div>
                                                                    {active && <input type="text" placeholder="è¨­å®šçµ„æ•¸" value={w_exercises[idx].sets} onChange={e=>{const val=e.target.value; setWExercises(prev=>prev.map((it,i)=>i===idx?{...it,sets:val}:it))}} onClick={e=>e.stopPropagation()} className="!bg-ingray rounded-kxl px-3 h-[40px] text-[12px] outline-none border-none mt-1 text-brand text-brand text-brand" />}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="space-y-2 text-brand text-brand"><p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand">è¨“ç·´ç­†è¨˜</p><textarea value={w_note} onChange={e=>setWNote(e.target.value)} className="w-full h-32 bg-ingray rounded-kxl p-4 text-[14px] outline-none shadow-inner focus:ring-2 focus:ring-orange-100 resize-none text-brand text-brand" placeholder="è¨˜éŒ„ä»Šå¤©çš„èº«é«”æ„Ÿå—..." /></div>
                                        </>
                                    ) : (
                                        <>
                                            {['breakfast', 'lunch', 'dinner', 'snacks'].map((meal) => (
                                                <div key={meal} className="space-y-3 text-brand text-brand text-brand">
                                                    <p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand text-brand">{meal === 'breakfast' ? 'æ—©é¤' : meal === 'lunch' ? 'åˆé¤' : meal === 'dinner' ? 'æ™šé¤' : 'é»å¿ƒ'}</p>
                                                    <textarea value={meal==='breakfast'?d_breakfast:meal==='lunch'?d_lunch:meal==='dinner'?d_dinner:d_snacks} onChange={(e)=>meal==='breakfast'?setDBreakfast(e.target.value):meal==='lunch'?setDLunch(e.target.value):meal==='dinner'?setDDinner(e.target.value):setDSnacks(e.target.value)} className="w-full bg-ingray rounded-kxl p-4 text-[14px] shadow-inner focus:ring-2 focus:ring-orange-100 min-h-[80px] resize-none text-brand text-brand" placeholder="é»æ“Šç´€éŒ„..." />
                                                    <div className="flex flex-wrap gap-2 items-center text-brand">
                                                        {commonFoods[meal]?.map((food, idx) => (<button key={idx} onClick={()=>handleQuickAddFood(meal==='breakfast'?setDBreakfast:meal==='lunch'?setDLunch:meal==='dinner'?setDDinner:setDSnacks, meal==='breakfast'?d_breakfast:meal==='lunch'?d_lunch:meal==='dinner'?d_dinner:d_snacks, food)} className="option-tag h-[36px]">{food}<span className="text-[10px] opacity-20 ml-1" onClick={(e)=>{e.stopPropagation(); handleRemoveLabelInline(meal, idx);}}>âœ•</span></button>))}
                                                        {inlineAddingMeal === meal ? (<div className="flex gap-1 animate-in slide-in-from-left-2 duration-200 text-brand text-brand text-brand text-brand"><input autoFocus value={newLabelText} onChange={(e) => setNewLabelText(e.target.value)} onBlur={()=>!newLabelText && setInlineAddingMeal(null)} onKeyDown={(e)=>e.key==='Enter' && handleAddLabelInline(meal)} className="w-24 !bg-white border border-accent rounded-kxl px-2 h-[36px] outline-none !p-1 text-brand text-brand" placeholder="æ¨™ç±¤" /><button onClick={()=>handleAddLabelInline(meal)} className="p-1 bg-accent text-white rounded-kxl h-[36px] w-[36px] flex items-center justify-center text-brand text-brand"><Icon name="check" size={14}/></button><button onClick={()=>setInlineAddingMeal(null)} className="p-1 bg-gray-100 text-gray-400 rounded-kxl h-[36px] w-[36px] flex items-center justify-center text-brand text-brand"><Icon name="x" size={14}/></button></div>) : (<button onClick={()=>setInlineAddingMeal(meal)} className="p-2 border border-dashed border-gray-300 rounded-kxl text-primary text-[12px] flex items-center gap-1 active:scale-95 h-[36px] text-brand">æ–°å¢</button>)}
                                                    </div>
                                                </div>
                                            ))}
                                            <div className="space-y-2 text-brand text-brand"><p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand">é£²é£Ÿæ¨™ç±¤</p><div className="flex gap-2 flex-wrap">{DIET_TAGS.map(t => <button key={t} onClick={()=>setDTags(v=>v.includes(t)?v.filter(i=>i!==t):[...v,t])} className={`px-4 h-[40px] rounded-kxl text-[12px] font-bold border transition-all ${d_tags.includes(t)?'bg-brand text-white border-brand shadow-md' : 'bg-white border-gray-200 text-primary'}`}>{t}</button>)}</div></div>
                                        </>
                                    )}
                                </div>
                                <div className="absolute bottom-0 left-0 right-0 p-page bg-white/80 backdrop-blur-md border-t border-primary/5 pb-8 z-30">
                                    <button onClick={entryType==='workout'?handleSaveWorkout:handleSaveDiet} disabled={entryType==='workout'?!isWorkoutValid:!isDietValid} className="w-full h-[44px] bg-accent text-white rounded-kxl font-bold shadow-lg active:scale-95 transition-all text-[16px] shadow-orange-100 text-brand">{editingId ? 'ç¢ºèªä¸¦æ›´æ–°' : 'å„²å­˜ç´€éŒ„'}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* New Plan Modal: Bottom Sheet å›æ­¸ + 16px åœ“è§’èˆ‡å°ºå¯¸æ ¡æº– */}
                    {showPlanModal && (
                        <div className="absolute inset-0 z-[120] flex items-end animate-in fade-in duration-300 text-brand">
                            <div className="absolute inset-0 bg-[#040316]/40 backdrop-blur-sm" onClick={() => setShowPlanModal(false)} />
                            <div className="w-full bg-white rounded-t-kxl h-[85vh] z-10 flex flex-col animate-in slide-in-from-bottom-full duration-500 shadow-2xl border-t border-primary/20 overflow-hidden text-brand text-brand text-brand text-brand">
                                <header className="px-6 h-[56px] border-b border-primary/5 flex justify-between items-center bg-white sticky top-0 z-20 text-brand">
                                    <div className="w-10"></div>
                                    <h3 className="text-[18px] font-bold text-brand">è¨­å®šæ–°è¡åˆºç›®æ¨™</h3>
                                    <button onClick={() => setShowPlanModal(false)} className="p-2 text-primary active:scale-90 hover:text-brand text-brand"><Icon name="x" size={24}/></button>
                                </header>
                                <div className="flex-1 overflow-y-auto px-6 pt-6 pb-[100px] space-y-8 no-scrollbar text-brand text-brand text-brand text-brand">
                                    <div className="space-y-2 text-brand">
                                        <p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand">é”æˆæ—¥æœŸ</p>
                                        <div className="date-input-container shadow-sm text-brand text-brand">
                                            <input type="date" value={newPlanDate} onChange={e=>setNewPlanDate(e.target.value)} className="w-full bg-transparent font-bold text-accent outline-none h-full text-brand" />
                                            <div className="absolute right-4 text-accent pointer-events-none opacity-40 text-brand text-brand"><Icon name="calendar" size={20} /></div>
                                        </div>
                                        <div className="flex gap-2 pt-1 text-brand">
                                            {[7, 14, 30].map(d => <button key={d} onClick={() => handleSetPresetDate(d)} className="px-4 h-[36px] bg-white border border-gray-200 rounded-kxl text-[12px] font-bold active:scale-95 text-brand text-brand">{d}å¤©</button>)}
                                        </div>
                                    </div>
                                    <div className="space-y-2 text-brand text-brand text-brand">
                                        <p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand">è¨ˆç•«åç¨±</p>
                                        <input value={newPlanTitle} onChange={e=>setNewPlanTitle(e.target.value)} className="w-full h-[40px] bg-ingray rounded-kxl px-4 outline-none shadow-inner text-brand" placeholder="ä¾‹å¦‚ï¼šéŸ“åœ‹ 14 å¤©è¡åˆº" />
                                    </div>
                                    <div className="space-y-2 text-brand text-brand text-brand text-brand text-brand">
                                        <p className="text-[16px] font-bold uppercase tracking-widest ml-1 text-brand">ç›®æ¨™é«”é‡</p>
                                        <div className="flex items-center bg-ingray rounded-kxl px-4 h-[40px] shadow-inner text-brand text-brand">
                                            <input type="number" step="0.1" value={newPlanTargetWeight} onChange={e=>setNewPlanTargetWeight(e.target.value)} className="w-full bg-transparent outline-none font-bold h-full text-brand" placeholder="54.0" />
                                            <span className="text-[12px] font-bold opacity-30 ml-2">KG</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="absolute bottom-0 left-0 right-0 p-page bg-white/80 backdrop-blur-md border-t border-primary/5 pb-8 z-30">
                                    <button onClick={handleCreatePlan} disabled={!newPlanTitle || !newPlanDate} className="w-full h-[44px] bg-accent text-white rounded-kxl font-bold shadow-lg shadow-orange-100 active:scale-95 transition-all text-brand">å•Ÿå‹•è¨ˆç•«</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
